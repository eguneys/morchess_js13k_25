const t=""+new URL("sprites_with_bg_alpha_working-COLVtoaS.png",import.meta.url).href;function e(t,e){let[o,i,n,s]=t,[r,a,l,h]=e;return o<r+l&&o+n>r&&i<a+h&&i+s>a}function o(t){let e,o,i,n,s,r=!1,a=0;function l(e){return[e[0]*t.width,e[1]*t.height]}return function(t,e){const o=t=>{let[e,o]=(t=>{if(t.clientX||0===t.clientX)return[t.clientX,t.clientY]})(t)??[0,0];return[(e-i.left)/i.width,(o-i.top)/i.height]};let i,n=t.getContext("2d");function s(){i=t.getBoundingClientRect(),n.imageSmoothingEnabled=!1}function r(){s()}s(),t.addEventListener("pointerdown",function(i){t.setPointerCapture(i.pointerId);let n=o(i);e.on_down(n)},{passive:!1}),t.addEventListener("pointermove",function(t){let i=o(t);e.on_move(i)},{passive:!1}),document.addEventListener("pointerup",function(t){let i=o(t);e.on_up(i)}),new ResizeObserver(s).observe(t),document.addEventListener("scroll",r,{capture:!0,passive:!0}),window.addEventListener("resize",r,{passive:!0})}(t,{on_down(t){t=l(t),i=void 0,o=t,n=t,r=!1},on_up(t){t=l(t),o=void 0,e=void 0,i=t},on_move(t){t=l(t),e=t,r=!0}}),{get is_hovering(){return e},get is_down(){return o},get is_up(){return i},get is_just_down(){return n},get is_double_click(){return s},get has_moved_after_last_down(){return r},update(t){var e,o,r;s=void 0,n&&a>0&&(s=n,a=0),r=t,a=(e=a)<(o=0)?Math.min(e+r,o):e>o?Math.max(e-r,o):e,n=void 0,i=void 0}}}let i=440*Math.pow(Math.pow(2,1/12),-9),n=/^[0-9.]+$/,s=/\s+/,r=/(\d+)/,a={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(t,e){t.split("-").forEach(function(t){a[t]=e})});class l{frequency;duration;constructor(t){let e=t.split(s);var o;this.frequency=function(t){var e=t.split(r),o=a[e[0]],n=(parseInt(e[1])||4)-4;return i*Math.pow(Math.pow(2,1/12),o)*Math.pow(2,n)}(e[0])||0,this.duration=(o=e[1],(n.test(o)?parseFloat(o):o.toLowerCase().split("").reduce(function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)},0))||0)}}class h{cx;tempo;notes;loop;smoothing;staccato;eqs;gain;osc;wave_type;constructor(t,e=120,o=[],i=!0){this.cx=t,this.tempo=e,this.osc=null,this.create_fx_nodes(),this.loop=i,this.smoothing=0,this.staccato=0,this.notes=[],this.push(o)}push(t){this.notes.push(...t.map(t=>new l(t)))}create_fx_nodes(){var t=this.gain=this.cx.createGain();return this.eqs={bass:void 0,mid:void 0,treble:void 0},[["bass",100],["mid",1e3],["treble",2500]].forEach(e=>{let o=this.eqs[e[0]]=this.cx.createBiquadFilter();o.type="peaking",o.frequency.value=e[1],t.connect(t=o)}),t.connect(this.cx.destination),this}create_oscillator(){return this.stop(),this.osc=this.cx.createOscillator(),this.osc.type=this.wave_type||"square",this.osc.connect(this.gain),this}schedule_note(t,e){var o=60/this.tempo*this.notes[t].duration,i=o*(1-(this.staccato||0));return this.set_frequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,i),this.set_frequency(0,e+i),e+o}get_next_note(t){return this.notes[t<this.notes.length-1?t+1:0]}get_slide_start_delay(t){return t-Math.min(t,60/this.tempo*this.smoothing)}slide(t,e,o){var i=this.get_next_note(t),n=this.get_slide_start_delay(o);return this.set_frequency(this.notes[t].frequency,e+n),this.ramp_frequency(i.frequency,e+o),this}set_frequency(t,e){return this.osc.frequency.setValueAtTime(t,e),this}ramp_frequency(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this}play(t){return t="number"==typeof t?t:this.cx.currentTime,this.create_oscillator(),this.osc.start(t),this.notes.forEach((e,o)=>{t=this.schedule_note(o,t)}),this.osc.stop(t),this.osc.onended=this.loop?()=>this.play(t):null,this}stop(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this}}let c=new AudioContext,u=c.currentTime,f=[],p=[];f=["G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h","G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h","E4 q","F#4 q","G4 h","G4 h","A4 q","B4 q","C5 q","B4 q","A4 h","A4 h","F#4 q","G4 q","E4 q","F#4 q","A4 q","G4 q","F#4 h","G4 q","B4 q","C5 h","A4 h","D5 q","C4 q","B3 h"],p=["G4 h","D4 h","G4 h","D4 h","B4 h","D4 h","D4 h","G4 h","C4 h","D4 h","G4 h","E4 h","A4 h","D4 h","G4 h","D4 q","G4 h","D4 h","G4 h","D4 h","B4 h","D4 h","D4 h","G4 h","C4 h","D4 h","G4 h","E4 h","A4 h","D4 h","G4 h","D4 q","E4 h","D4 h","G4 h","C4 h","A4 h","C4 h","B4 h","D4 h","D4 h","B4 h","D4 h","B4 h","C4 h","G4 h","E4 h","G4 q"];let d=new h(c,96,f),w=new h(c,96,[]),m=new h(c,96,p);function _(){d.play(u),m.play(u)}function k(){d.stop(),m.stop()}d.staccato=.55,w.staccato=.55,m.staccato=.6,m.smoothing=.01,d.gain.gain.value=.07,w.gain.gain.value=.06,m.gain.gain.value=.024,d.eqs.mid.frequency.value=800,d.eqs.mid.gain.value=3,w.eqs.mid.frequency.value=1200,w.eqs.mid.gain.value=3,m.eqs.bass.gain.value=6,m.eqs.bass.frequency.value=80,m.eqs.mid.gain.value=-6,m.eqs.mid.frequency.value=500,m.eqs.treble.gain.value=-2,m.eqs.treble.frequency.value=1400;const b=t=>Math.sin(t),g=t=>(t%6.28-3.14)/6.28,v=t=>{return e=1e3*Math.sin(t),o=-1,i=1,Math.max(Math.min(e,i),o);var e,o,i};async function y(t,e){let o=c.sampleRate,i=c.createBuffer(1,o*t,o),n=i.getChannelData(0),s=i.length;for(let r=0;r<s;r++)n[r]=e(44100*r/o)*(1-r/s)*.4;return await async function(){return new Promise(t=>setTimeout(t,0))}(),i}function q(t){let e=c.createBufferSource();e.buffer=t,e.connect(c.destination),e.start()}const C=()=>Math.random();let M=await y(.3,t=>.1*b(t/44100*2*Math.PI*440*g(t/44100*2*Math.PI*440)*.1)),P=await y(.2,t=>.1*v(t/44100*2*Math.PI*440*g(t/44100*2*Math.PI*440*t/100)*.1)),x=await y(3,t=>t/44100%.2<.1?.5*b(.05*C()+2*t*Math.PI*140/44100):t/44100<.6?.2*b(2*g(t/44100*2*Math.PI*840)*Math.PI*340/44100):.1*b(2*t*Math.PI*840/44100)),B=await y(4,t=>t/44100%.04<.02?.1*v(2*t*Math.PI*(840*t/.4)/44100):t/44100<.6?.2*v(2*g(t/44100*2*Math.PI*(t/500+340))*Math.PI*340/44100):.1*v(2*t*Math.PI*(t/10500+660)/44100));const $={drop:await y(.12,t=>t/44100%.2<.1?.5*b(.05*C()+2*t*Math.PI*140/44100):t/44100<.6?.2*b(t/44100*2*Math.PI*(100+.1*t)):.1*b(2*t*Math.PI*840/44100)),correct:x,next:P,chapter:M,done_chapter:B},E=t=>(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),A=t=>(t=t>>>8&16711935|(16711935&t)<<8)>>>16&65535|(65535&t)<<16,L=t=>A(t=(t=(t=t>>>1&1431655765|(1431655765&t)<<1)>>>2&858993459|(858993459&t)<<2)>>>4&252645135|(252645135&t)<<4);class G{lo;hi;constructor(t,e){this.lo=0|t,this.hi=0|e}static fromSquare(t){return t>=32?new G(0,1<<t-32):new G(1<<t,0)}static fromRank(t){return new G(255,0).shl64(8*t)}static fromFile(t){return new G(16843009<<t,16843009<<t)}static empty(){return new G(0,0)}static full(){return new G(4294967295,4294967295)}static corners(){return new G(129,2164260864)}static center(){return new G(402653184,24)}static backranks(){return new G(255,4278190080)}static backrank(t){return"white"===t?new G(255,0):new G(0,4278190080)}static lightSquares(){return new G(1437226410,1437226410)}static darkSquares(){return new G(2857740885,2857740885)}complement(){return new G(~this.lo,~this.hi)}xor(t){return new G(this.lo^t.lo,this.hi^t.hi)}union(t){return new G(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new G(this.lo&t.lo,this.hi&t.hi)}diff(t){return new G(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?G.empty():t>=32?new G(this.hi>>>t-32,0):t>0?new G(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?G.empty():t>=32?new G(0,this.lo<<t-32):t>0?new G(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new G(A(this.hi),A(this.lo))}rbit64(){return new G(L(this.hi),L(this.lo))}minus64(t){const e=this.lo-t.lo,o=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new G(e,this.hi-(t.hi+o))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return E(this.lo)+E(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(t){return 0!=(t>=32?this.hi&1<<t-32:this.lo&1<<t)}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new G(this.lo,this.hi|1<<t-32):new G(this.lo|1<<t,this.hi)}without(t){return t>=32?new G(this.lo,this.hi&~(1<<t-32)):new G(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new G(this.lo,this.hi^1<<t-32):new G(this.lo^1<<t,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new G(this.lo&this.lo-1,this.hi):new G(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||!!(this.lo&this.lo-1)||!!(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield e}for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield 32+t}}*reversed(){let t=this.lo,e=this.hi;for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield 32+t}for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield e}}}const D=t=>t>>3,F=t=>7&t,K=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,R=(t,e)=>{let o=G.empty();for(const i of e){const e=t+i;0<=e&&e<64&&Math.abs(F(t)-F(e))<=2&&(o=o.with(e))}return o},I=t=>{const e=[];for(let o=0;o<64;o++)e[o]=t(o);return e},T=I(t=>R(t,[-9,-8,-7,-1,1,7,8,9])),j=I(t=>R(t,[-17,-15,-10,-6,6,10,15,17])),z={white:I(t=>R(t,[7,9])),black:I(t=>R(t,[-7,-9]))},S=I(t=>G.fromFile(F(t)).without(t)),O=I(t=>G.fromRank(D(t)).without(t)),N=I(t=>{const e=new G(134480385,2151686160),o=8*(D(t)-F(t));return(o>=0?e.shl64(o):e.shr64(-o)).without(t)}),Q=I(t=>{const e=new G(270549120,16909320),o=8*(D(t)+F(t)-7);return(o>=0?e.shl64(o):e.shr64(-o)).without(t)}),V=(t,e,o)=>{let i=o.intersect(e),n=i.bswap64();return i=i.minus64(t),n=n.minus64(t.bswap64()),i.xor(n.bswap64()).intersect(e)},X=(t,e)=>{const o=G.fromSquare(t);return V(o,N[t],e).xor(V(o,Q[t],e))},U=(t,e)=>((t,e)=>V(G.fromSquare(t),S[t],e))(t,e).xor(((t,e)=>{const o=O[t];let i=e.intersect(o),n=i.rbit64();return i=i.minus64(G.fromSquare(t)),n=n.minus64(G.fromSquare(63-t)),i.xor(n.rbit64()).intersect(o)})(t,e)),W=(t,e,o)=>{switch(t.role){case"pawn":return((t,e)=>z[t][e])(t.color,e);case"knight":return(t=>j[t])(e);case"bishop":return X(e,o);case"rook":return U(e,o);case"queen":return((t,e)=>X(t,e).xor(U(t,e)))(e,o);case"king":return(t=>T[t])(e)}};function Y(t){return function(t){let e=[],o=function(t){let e=[],o=function(t){let e=G.empty();for(let o of Object.keys(t))e=e.set(t[o],!0);return e}(t);for(let i of Object.keys(t)){let n=it(i),s=t[i],r=W(n,s,o);for(let a of r)for(let l of Object.keys(t))if(t[l]===a){let a,h=t[l],c=o.without(h),u=W(n,s,c).diff(r);for(let e of u)for(let o of Object.keys(t))t[o]===e&&(a=o);void 0!==a?e.push([i,l,a]):e.push([i,l])}}return e.sort((t,e)=>t.join(" ").localeCompare(e.join(" "))),e}(t);for(let i of Object.keys(t)){let t=[],n=[],s=[],r=[],a=[];for(let e of o)e[0]===i?2===e.length?t.push(e[1]):r.push([e[1],e[2]]):e[1]===i?2===e.length?n.push(e[0]):s.push([e[0],e[2]]):e[2]===i&&a.push([e[0],e[1]]);e.push({p1:i,attacks:t,attacked_by:n,blocks:s,blocked_attacks:r,blocked_attacked_by:a})}return e}(tt(t))}const Z=t=>!t.attacked_by.find(t=>t.toLowerCase()===t)&&!t.blocked_attacked_by.find(t=>t[0].toLowerCase()===t[0])&&!t.blocks.find(t=>t[0].toLowerCase()===t[0]),H=t=>!t.attacked_by.find(t=>t.toLowerCase()!==t)&&!t.blocked_attacked_by.find(t=>t[0].toLowerCase()!==t[0])&&!t.blocks.find(t=>t[0].toLowerCase()!==t[0]);function J(t){let e=t.p1,o=t.attacks.map(t=>`+${t}`).join(" "),i=t.attacked_by.map(t=>`${t}+`).join(" "),n=t.blocks.map(t=>`${t[0]}+|${t[1]}`).join(" "),s=t.blocked_attacks.map(t=>`+${t[0]}/${t[1]}`).join(" "),r=t.blocked_attacked_by.map(t=>`${t[0]}+/${t[1]}`).join(" "),a=[e];return Z(t)&&a.push("z+"),H(t)&&a.push("Z+"),""!==o&&a.push(o),""!==i&&a.push(i),""!==n&&a.push(n),""!==s&&a.push(s),""!==r&&a.push(r),a.join(" ")}function tt(t){t=t.split(" ")[0];let e={},o=7;for(let i of t.split("/")){let t=0;for(let n of i)if(ot(n)){let i=K(t,o);if(void 0!==i){let t=n,o=2;for(;void 0!==e[t];)t=n+o,o++;e[t]=i}t+=1}else t+=parseInt(n);o-=1}return e}const et={r:"rook",n:"knight",b:"bishop",p:"pawn",q:"queen",k:"king"};function ot(t){return void 0!==et[t.toLowerCase()]}function it(t){var e;return{color:(e=t).toLowerCase()===e?"black":"white",role:et[t.toLowerCase().replace(/[2345678]/,"")]}}console.log(Y("8/8/4r3/r1n5/1k1B4/6Np/1PP1n3/2KRR3 w - - 0 1").map(J));let nt,st,rt,at,lt=await function(t){let e=new Image;return new Promise(o=>{e.onload=()=>o(e),e.src=t})}(t);function ht(t,e,o,i=1,n=i){let s,r,a;e=Math.floor(e),o=Math.floor(o),t<4?(s=32,r=32*t,a=0):t<28?(s=16,r=(t-=4)%8*16,a=32+16*Math.floor(t/8)):(s=8,r=(t-=28)%16*8,a=80+8*Math.floor(t/16)),st.drawImage(lt,r,a,s,s,e,o,s*i,s*n)}function ct(t){at.font="42px Arial",at.shadowColor="black",at.shadowBlur=4;let e=1308,o=803.25;ut(t[0],e,o,600,60),at.font="28px Arial",e=1308,o=1039.5,ut(t[1],e,o,600,60)}function ut(t,e,o,i,n){const s=t.split(" ");let r="",a=o;for(let l=0;l<s.length;l++){const t=r+s[l]+" ";at.measureText(t).width>i&&l>0?(at.fillText(r,e,a),r=s[l]+" ",a+=n):r=t}at.fillText(r,e,a)}function ft(){at.clearRect(0,0,1920,1080),st.fillRect(0,0,320,180),ht(110,0,0,320);let t=10,e=24;for(let i=0;i<8;i++)for(let o=0;o<8;o++){ht(108+((i+o)%2==1?1:0),t+3.5*i*8,e+3.5*o*8,3.5)}t=10,e=0,ht(111,t,e,28,3),e=248,ht(111,t,e,28,3);for(let i of Ut)ht(Dt(i.piece),...i.pos,3),i.piece.match(/2/)&&ht(82,...i.pos,3),i.is_hovering&&ht(112,...i.pos,3);ht(111,318,188,20,10),ct(ne||(oe||(ie||ee))),ht(111,238,2,30,23);let o=Vt.find(t=>t.is_hovering);if(o){let[t,e,i,n]=o.bb;st.strokeRect(t,e,i,n);for(let s of o.circles)ht(112,...s,3);for(let s of o.no_arrows)Ct(s[0],s[1],"red");for(let s of o.yes_arrows)Ct(s[0],s[1],"green")}for(let i of Qt)ht(i[0],i[1],i[2]);if(Xt&&ht(Dt(Xt.piece),...Xt.pos,3),void 0!==oe){!function(t,e,o,i){for(let n=0;n<e;n++)ht(t+n,o+8*n*2,i,2)}(119,5,400,246+(ae&&se%500<200?2:0))}if(function(){let t=yt,e=qt;ht(111,238,188,9.8,10);let o=Ht[Zt];at.font="bold 64px Arial",at.fillText(`${o.chapter}-${o.level}`,265*t,204*e);let i=se%500<250?3:0,n=he?i:0;ht(117,242-(le?i:0),190,2),ht(118,296+n,190,2),ht(wt+(Ht[Zt].is_revealed?16:Ht[Zt].is_solved?8:0),250,214,3),ht(void 0===fe||fe?116:115,298,214,2)}(),ht(28,...Yt),ce){let t=80*Math.sin(.008*se),e=80*Math.sin(.008*se),o=80*Math.sin(.003*se);at.font="bold 180px Arial",at.shadowColor="purple",at.shadowBlur=10,at.lineWidth=4,at.strokeStyle="purple",at.strokeText("Mor",200+t,400+e),at.strokeText("Chess",1e3-t,400+e),at.fillStyle="white",at.shadowBlur=0,at.fillText("Mor",200+t,400+e),at.fillText("Chess",1e3-t,400+e),at.fillStyle="black",at.fillText("Black",200,800-.1*o),at.fillText("Cat",800,800-.1*o)}}let pt,dt,wt,mt,_t=[250,214,48,48],kt=[298,214,16,16];const bt={neutral:4,happy:5,sad:6,angry:7,surprised:8,sleepy:9,playful:10},gt=[242,190,16,16],vt=[296,190,16,16],yt=4,qt=4;function Ct(t,e,o){at.lineWidth=10,at.strokeStyle=o,at.lineCap="round",at.beginPath(),at.moveTo(t[0]*yt,t[1]*qt),at.lineTo(e[0]*yt,e[1]*qt),at.stroke()}const Mt=[400,246,80,16];function Pt(t,e){return J(t)===J(e)}const xt=(t,e,o)=>Qt.push([t,e,o,0]),Bt=(t,e,o,i,n,s,r,a)=>Vt.push({info:t,bb:[e,o,i,n],is_hovering:!1,circles:s,yes_arrows:r,no_arrows:a});function $t(t,e,o){const i=t=>Ut.filter(e=>e.piece===t&&void 0!==It(e.pos)).map(t=>t.pos),n=(t,e)=>{let o=Ut.filter(e=>e.piece===t&&void 0!==It(e.pos)).map(t=>t.pos)[0],i=Ut.filter(t=>t.piece===e&&void 0!==It(t.pos)).map(t=>t.pos)[0];if(o&&i){return[[[o[0]+12,o[1]+12],[i[0]+12,i[1]+12]]]}return[]};let s=[],r=[],a=[];const l=(t,e,o,i,n)=>{Bt(t,e,o,i,n,s,r,a),s=[],r=[],a=[]},h=xt;h(Dt(t.p1),e+4,o+4),t.p1.match(/2/)&&h(82,e+4,o+4),s=i(t.p1),l(Et.yes_piece(t.p1),e+2,o+2,12,12),h(39,(e+=8)+4,o+4),e+=8;let c=jt();if(Z(t)){let r=c.find(e=>e.p1===t.p1),u=r?.attacked_by.filter(t=>t.toLowerCase()===t)??[];u=u.concat(r?.blocks.map(t=>t[0]).filter(t=>t.toLowerCase()===t)??[]),a=[...u.flatMap(e=>n(t.p1,e))],t.p1.toLowerCase()===t.p1?h(33,e+4,o+4):h(32,e+4,o+4),s=i(t.p1),l(Et.zero_attacked_by_lower(t.p1),e+2,o+2,12,12),e+=12}if(H(t)){let r=c.find(e=>e.p1===t.p1),u=r?.attacked_by.filter(t=>t.toLowerCase()!==t)??[];u=u.concat(r?.blocks.map(t=>t[0]).filter(t=>t.toLowerCase()!==t)??[]),a=[...u.flatMap(e=>n(t.p1,e))],t.p1.toLowerCase()===t.p1?h(32,e+4,o+4):h(33,e+4,o+4),s=i(t.p1),l(Et.zero_attacked_by_upper(t.p1),e+2,o+2,12,12),e+=12}for(let u of t.attacks){h(35,e+2,o+4);let i=c.find(e=>e.p1===t.p1);0===(i?.attacks.filter(t=>t===u)??[]).length?a=[...n(t.p1,u)]:r=[...n(t.p1,u)],l(Et.attacks(t.p1,u),e+4,o+2,14,12),e+=5,h(Dt(u),e+4,o+4),u.match(/2/)&&h(82,e+4,o+4),e+=9}for(let u of t.attacked_by){h(Dt(u),e+4,o+4),u.match(/2/)&&h(82,e+4,o+4);let f=c.find(e=>e.p1===t.p1);0===(f?.attacked_by.filter(t=>t===u)??[]).length?a=[...n(t.p1,u)]:r=[...n(t.p1,u)],s=i(t.p1),l(Et.attacked_by(t.p1,u),e+4,o+2,14,12),h(34,(e+=9)+2,o+4),e+=5}for(let u of t.blocks){h(Dt(u[1]),e+4,o+4),u[1].match(/2/)&&h(82,e+4,o+4);let i=c.find(e=>e.p1===t.p1);0===(i?.blocks.filter(t=>t[0]===u[0]&&t[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(t.p1,u[1])]:r=[...n(u[0],u[1])],l(Et.blocks(t.p1,...u),e+4,o+2,24,12),h(36,(e+=9)+2,o+4),e+=5,h(Dt(u[0]),e+4,o+4),u[0].match(/2/)&&h(82,e+4,o+4),e+=9}for(let u of t.blocked_attacks){h(Dt(u[1]),e+4,o+4),u[0].match(/2/)&&h(82,e+4,o+4);let i=c.find(e=>e.p1===t.p1);0===(i?.blocked_attacks.filter(t=>t[0]===u[0]&&t[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(t.p1,u[1])]:r=[...n(t.p1,u[1])],l(Et.blocked_attacks(t.p1,u[1],u[0]),e+4,o+2,24,12),h(37,(e+=9)+2,o+4),e+=5,h(Dt(u[0]),e+4,o+4),u[0].match(/2/)&&h(82,e+4,o+4),e+=9}for(let u of t.blocked_attacked_by){h(Dt(u[1]),e+4,o+4),u[1].match(/2/)&&h(82,e+4,o+4);let i=c.find(e=>e.p1===t.p1),s=i?.blocked_attacked_by.filter(t=>t[0]===u[0]&&t[1]===u[1])??[];0===s.length?a=[...n(u[0],u[1]),...n(t.p1,u[0])]:r=[...n(t.p1,u[0])],s=i?.attacked_by.filter(t=>t===u[0]).map(t=>[t,t])??[],s=s.concat(i?.blocks.filter(t=>t[0]===u[0])??[]),s.length>0&&(a=[...n(t.p1,u[0])]),l(Et.blocked_attacked_by(t.p1,u[0],u[1]),e+4,o+2,24,12),h(38,(e+=9)+2,o+4),e+=5,h(Dt(u[0]),e+4,o+4),u[0].match(/2/)&&h(82,e+4,o+4),e+=9}return[e,o]}const Et={welcome0:["welcome to mor chess; drag pieces onto the board, but there are some rules above. hover over them for details.","drag a piece off the board to remove it."],welcome1:["each chapter; proressively reveals more pieces of a single position.","call out the cat 3 times, if you get in a mess ;)"],welcome2:["chess tactics; are born out of relationships.","our job is to entangle them."],welcome3:["rules are tools to an end.","look here, just enough to keep the cats happy."],well_done:["Congratulations, you satisfied all rules. Time to go deeper.","Click Next to continue."],well_end:["the end; chess is fascinating isn't it, go play some chess.","Thank's for playing"],equals:t=>["left side is the goal, right side is the board; your goal is to match them equal.",`this rule ${t?"has matched correctly.":"has not been matched yet."}`],no_piece:t=>[`${Gt(t)} hasn't been placed yet.`,""],yes_piece:t=>[`A ${Gt(t)} on the board.`,""],zero_attacked_by_lower(t){let e=t.toLowerCase()===t?"defenders":"attackers";return[`${Gt(t)} has zero ${e}.`,""]},zero_attacked_by_upper(t){let e=t.toLowerCase()===t?"attackers":"defenders";return[`${Gt(t)} has zero ${e}.`,""]},attacks(t,e){let o=Gt(t),i=Gt(e);return[`${o} is ${At(t,e)} ${i}.`,`${i} shouldn't be blocking an attack of ${o}.`]},attacked_by(t,e){let o=Gt(t),i=Gt(e);return[`${o} is ${Lt(t,e)} by ${i}.`,""]},blocks(t,e,o){let i=Gt(t),n=Gt(e),s=Gt(o);return[`${i} blocks ${n} ${At(e,o)} ${s}.`,""]},blocked_attacks(t,e,o){let i=Gt(t),n=Gt(e),s=Gt(o);return[`${i} is ${At(t,e)} ${n}, but that's blocked by ${s}.`,""]},blocked_attacked_by(t,e,o){let i=Gt(t),n=Gt(e),s=Gt(o);return[`${i} is ${Lt(t,e)} by ${n}, but that's blocked by ${s}.`,""]}},At=(t,e)=>t.toLowerCase()===t==(e.toLowerCase()===e)?"defending":"attacking",Lt=(t,e)=>t.toLowerCase()===t==(e.toLowerCase()===e)?"defended":"attacked";function Gt(t){let e=it(t),o=t.match(/2/)?"2":"";return e.role[0].toUpperCase()+e.role.slice(1)+o}function Dt(t){let e=it(t);return 76+{pawn:0,rook:1,bishop:2,knight:3,queen:4,king:5}[e.role]+("white"===e.color?16:0)}function Ft(t){if(mt-=t,mt<0&&(mt=0),mt>1e3&&(mt=0,Ht[Zt].is_revealed||(Ht[Zt].is_revealed=!0,function(){pe();let t=tt(Ht[Zt].fen);for(let e of Object.keys(t)){let o=F(t[e]),i=D(t[e]);Ut.push(Ot(e,Rt([o,7-i])))}Nt=!0}())),dt-=t,se+=t,dt<0&&(wt=se%1e4<2e3?bt.sleepy:bt.neutral),Wt.is_hovering){Yt=Wt.is_hovering;for(let t of Ut)t.is_hovering=!1;for(let t of Ut)if(e(St(t),zt(Yt))){t.is_hovering=!0;break}if(void 0!==Xt)Xt.pos=[Yt[0]-4,Yt[1]-4];else{for(let t of Vt)t.is_hovering=!1;for(let t of Vt)e(t.bb,zt(Yt))&&(t.is_hovering=!0)}re=e(_t,zt(Yt)),ae=void 0!==oe&&e(Mt,zt(Yt)),le=e(gt,zt(Yt)),he=e(vt,zt(Yt)),re&&dt<0&&(wt=bt.playful,dt=260)}if(Wt.is_just_down){let t=Ut.find(t=>t.is_hovering);if(t){t.is_dragging=!0,Xt=Ot(t.piece,t.pos),It(t.pos)&&(Xt.orig=t)}}if(Wt.is_up){if(void 0!==fe||ue||(fe=!1,_()),Xt){if(Xt.orig){let t=Xt.orig.pos;Ut=Ut.filter(e=>!(e.pos[0]===t[0]&&e.pos[1]===t[1]))}let t=It(Wt.is_up);if(t){let e=Rt(t);Ut=Ut.filter(t=>!(t.pos[0]===e[0]&&t.pos[1]===e[1])),Ut.push(Ot(Xt.piece,e))}!function(){for(let t of Ut){let e=It(t.pos);if(!e)continue;let o=Ut.find(o=>{if(o!==t&&o.piece[0]===t.piece[0]){let t=It(o.pos);if(t){let o=K(...e);if(K(...t)<o)return!0}}})?"2":"";t.piece=t.piece[0]+o}}(),Xt=void 0,Nt=!0,wt=bt.surprised,dt=3e3,q($.drop)}ae&&(Zt===Ht.length-1?Kt(0):Kt(1)),le&&Kt(-1),he&&Kt(1),e(kt,zt(Wt.is_up))&&(fe=!fe,fe?k():_()),re&&(wt=bt.sad,dt=1e3,mt+=540)}if(Nt){Nt=!1,Qt=[],Vt=[];let t=te(),e=jt(),o=0,i=!0,n=2;for(let s of t){let t=238;[t,n]=$t(s,t,n);let r=e.find(t=>t.p1===s.p1),a=void 0!==r&&Pt(s,r)?30:29;30===a&&o++,i=i&&30===a,xt(a,t+4,n+4),Bt(Et.equals(30===a),t+2,n+2,12,12,[],[],[]),t+=10,void 0===r?(xt(31,t+4,n+4),Bt(Et.no_piece(s.p1),t+2,n+2,12,12,[],[],[])):[t,n]=$t(r,t,n),n+=14,t=182}pt>o&&(wt=bt[Math.random()<.8?"angry":"sad"],dt=1500),pt=o,i?function(){Ht[Zt].is_solved=!0,Ht.filter(t=>t.chapter===Ht[Zt].chapter).every(t=>t.is_solved)?q($.done_chapter):q($.correct);wt=bt.playful,dt=5e3,Zt<Ht.length-1?-1===Ht.findIndex(t=>!t.is_solved)?ce=!0:oe=Et.well_done:-1===Ht.findIndex(t=>!t.is_solved)?ce=!0:oe=Et.well_end}():oe=void 0}if(ie=Vt.find(t=>t.is_hovering)?.info,Wt.update(t),ce){for(let e of Ut)e.pos[1]-=.1*t*Math.random(),e.pos[1]<-20&&(e.pos[1]=400);se%500<17&&(Zt+=1,Zt>Ht.length-1&&(Zt=0),Nt=!0)}}function Kt(t){Ht[Zt].is_revealed&&(Ht[Zt].is_revealed=!1,Ht[Zt].is_solved=!1);let e=Zt+t;if(0===t&&(e=Ht.findIndex(t=>!t.is_solved)),e<0||e>=Ht.length)return;let o=Ht[e].chapter!==Ht[Zt].chapter;o?(q($.chapter),pe()):q($.next),Nt=!0,Zt=e,o&&(ee=Et[`welcome${Ht[Zt].chapter}`],wt=bt.surprised,dt=5e3)}function Rt(t){return[10+3.5*t[0]*8+2,24+3.5*t[1]*8+4]}function It(t){let[e,o]=t;if(e-=10,o-=24,!(e<0||e>=224||o<0||o>=224))return e=Math.floor(e/28),o=Math.floor(o/28),[e,o]}function Tt(t){return Y(t)}function jt(){return Tt(function(){let t={};for(let o of Ut){let e=It(o.pos);if(e){let i=o.piece;t[K(...e)]=i}}let e="";for(let o=0;o<8;o++){let i=0;for(let n=0;n<8;n++){let s=K(n,o);t[s]?(i>0&&(e+=i),e+=t[s][0],i=0):i++}i>0&&(e+=i),e+="/"}return e}())}function zt(t){return[t[0]+1,t[1]+1,6,6]}function St(t){let[e,o]=t.pos;return[e,o,24,24]}function Ot(t,e){return{piece:t,pos:e,is_hovering:!1,is_dragging:!1}}let Nt,Qt,Vt,Xt,Ut,Wt,Yt,Zt,Ht=[Jt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",0,0),Jt("6k1/8/8/8/8/8/5P2/6K1 w - - 0 1",0,1),Jt("6k1/8/8/8/8/8/6PP/6K1 w - - 0 1",0,2),Jt("6k1/8/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,3),Jt("6k1/b7/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,4),Jt("1r4k1/bP6/8/8/8/5B2/5P2/6K1 w - - 0 1",0,5),Jt("1r4k1/bP6/4p3/3r4/8/5B2/5P2/6K1 w - - 0 1",0,6),Jt("1r4k1/bP6/4p3/p2r4/8/5B2/5P2/R5K1 w - - 0 1",0,7),Jt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",1,0),Jt("8/1K6/4b3/8/3r4/4k3/8/8 w - - 0 1",1,1),Jt("8/1K6/4b3/4R3/3rP3/4k3/8/8 w - - 0 1",1,2),Jt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",2,0),Jt("8/5k2/8/8/8/8/6PP/6K1 w - - 0 1",2,1),Jt("8/5k2/4rn2/8/8/8/6PP/6K1 w - - 0 1",2,2),Jt("8/5k2/8/8/8/8/8/R2R2K1 w - - 0 1",2,3),Jt("3r4/5k2/8/8/3n4/8/8/3R2K1 w - - 0 1",2,4),Jt("3r4/6k1/5rn1/8/3n4/8/6PP/3R2K1 w - - 0 1",2,5),Jt("3r4/6k1/5rn1/1p6/2Nn4/8/6PP/R2R2K1 w - - 0 1",2,6),Jt("3r4/5k2/4rn2/1p6/2N5/3n4/1B4PP/R2R2K1",2,7),Jt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",3,0),Jt("6k1/8/8/8/8/8/7q/1K1Q4 w - - 0 1",3,1),Jt("6k1/7p/8/8/8/8/2Pr3q/1K1QR3 w - - 0 1",3,2),Jt("6k1/7p/8/6p1/8/8/1PPr3q/1K1QR3 w - - 0 1",3,3)];function Jt(t,e,o){return{chapter:e,level:o,fen:t,is_solved:!1,is_revealed:!1}}const te=()=>Tt(Ht[Zt].fen);let ee,oe,ie,ne,se,re,ae,le,he,ce,ue,fe;function pe(){Ut=[Ot("p",[20,0]),Ot("n",[52,0]),Ot("b",[84,0]),Ot("r",[116,0]),Ot("q",[148,0]),Ot("k",[180,0]),Ot("P",[20,248]),Ot("N",[52,248]),Ot("B",[84,248]),Ot("R",[116,248]),Ot("Q",[148,248]),Ot("K",[180,248])]}!function(t){nt=document.createElement("canvas"),nt.width=480,nt.height=270,nt.classList.add("pixelated"),st=nt.getContext("2d"),st.imageSmoothingEnabled=!1,st.fillStyle="black",rt=document.createElement("canvas"),rt.width=1920,rt.height=1080,at=rt.getContext("2d");let e=document.createElement("div");e.classList.add("content"),e.appendChild(nt),e.appendChild(rt),t.appendChild(e),mt=0,ue&&k(),ue=!1,pt=0,wt=bt.happy,dt=5e3,ce=!1,le=!1,he=!1,ae=!1,se=0,ne=void 0,oe=void 0,ie=void 0,ee=Et.welcome0,Nt=!0,Qt=[],Vt=[],Zt=0,Xt=void 0,Ut=[],pe(),Wt=o(nt),Yt=[0,0],function(t,e){const o=1e3/60;let i=performance.now(),n=0;requestAnimationFrame(function s(r){requestAnimationFrame(s);let a=Math.min(r-i,1e3);for(i=r,n+=a;n>=o;)t(o),n-=o;e(n/o)})}(Ft,ft)}(document.getElementById("app"));
