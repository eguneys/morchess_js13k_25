const e=""+new URL("sprites_with_bg_alpha_working-COLVtoaS.png",import.meta.url).href;function t(e,t){let[o,i,n,s]=e,[r,a,l,h]=t;return o<r+l&&o+n>r&&i<a+h&&i+s>a}function o(e){let t,o,i,n,s,r=!1,a=0;function l(t){return[t[0]*e.width,t[1]*e.height]}return function(e,t){const o=e=>{let[t,o]=(e=>{if(e.clientX||0===e.clientX)return[e.clientX,e.clientY]})(e)??[0,0];return[(t-i.left)/i.width,(o-i.top)/i.height]};let i,n=e.getContext("2d");function s(){i=e.getBoundingClientRect(),n.imageSmoothingEnabled=!1}function r(){s()}s(),e.addEventListener("pointerdown",function(i){e.setPointerCapture(i.pointerId);let n=o(i);t.on_down(n)},{passive:!1}),e.addEventListener("pointermove",function(e){let i=o(e);t.on_move(i)},{passive:!1}),document.addEventListener("pointerup",function(e){let i=o(e);t.on_up(i)}),new ResizeObserver(s).observe(e),document.addEventListener("scroll",r,{capture:!0,passive:!0}),window.addEventListener("resize",r,{passive:!0})}(e,{on_down(e){e=l(e),i=void 0,o=e,n=e,r=!1},on_up(e){e=l(e),o=void 0,t=void 0,i=e},on_move(e){e=l(e),t=e,r=!0}}),{get is_hovering(){return t},get is_down(){return o},get is_up(){return i},get is_just_down(){return n},get is_double_click(){return s},get has_moved_after_last_down(){return r},update(e){var t,o,r;s=void 0,n&&a>0&&(s=n,a=0),r=e,a=(t=a)<(o=0)?Math.min(t+r,o):t>o?Math.max(t-r,o):t,n=void 0,i=void 0}}}let i=440*Math.pow(Math.pow(2,1/12),-9),n=/^[0-9.]+$/,s=/\s+/,r=/(\d+)/,a={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(e,t){e.split("-").forEach(function(e){a[e]=t})});class l{frequency;duration;constructor(e){let t=e.split(s);var o;this.frequency=function(e){var t=e.split(r),o=a[t[0]],n=(parseInt(t[1])||4)-4;return i*Math.pow(Math.pow(2,1/12),o)*Math.pow(2,n)}(t[0])||0,this.duration=(o=t[1],(n.test(o)?parseFloat(o):o.toLowerCase().split("").reduce(function(e,t){return e+("w"===t?4:"h"===t?2:"q"===t?1:"e"===t?.5:"s"===t?.25:0)},0))||0)}}class h{cx;tempo;notes;loop;smoothing;staccato;eqs;gain;osc;wave_type;constructor(e,t=120,o=[],i=!0){this.cx=e,this.tempo=t,this.osc=null,this.create_fx_nodes(),this.loop=i,this.smoothing=0,this.staccato=0,this.notes=[],this.push(o)}push(e){this.notes.push(...e.map(e=>new l(e)))}create_fx_nodes(){var e=this.gain=this.cx.createGain();return this.eqs={bass:void 0,mid:void 0,treble:void 0},[["bass",100],["mid",1e3],["treble",2500]].forEach(t=>{let o=this.eqs[t[0]]=this.cx.createBiquadFilter();o.type="peaking",o.frequency.value=t[1],e.connect(e=o)}),e.connect(this.cx.destination),this}create_oscillator(){return this.stop(),this.osc=this.cx.createOscillator(),this.osc.type=this.wave_type||"square",this.osc.connect(this.gain),this}schedule_note(e,t){var o=60/this.tempo*this.notes[e].duration,i=o*(1-(this.staccato||0));return this.set_frequency(this.notes[e].frequency,t),this.smoothing&&this.notes[e].frequency&&this.slide(e,t,i),this.set_frequency(0,t+i),t+o}get_next_note(e){return this.notes[e<this.notes.length-1?e+1:0]}get_slide_start_delay(e){return e-Math.min(e,60/this.tempo*this.smoothing)}slide(e,t,o){var i=this.get_next_note(e),n=this.get_slide_start_delay(o);return this.set_frequency(this.notes[e].frequency,t+n),this.ramp_frequency(i.frequency,t+o),this}set_frequency(e,t){return this.osc.frequency.setValueAtTime(e,t),this}ramp_frequency(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this}play(e){return e="number"==typeof e?e:this.cx.currentTime,this.create_oscillator(),this.osc.start(e),this.notes.forEach((t,o)=>{e=this.schedule_note(o,e)}),this.osc.stop(e),this.osc.onended=this.loop?()=>this.play(e):null,this}stop(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this}}let c=new AudioContext,u=96,p=[],f=[],d=["C4 q","E4 q","G4 q","C5 q","E5 q","D5 q","C5 q","G4 q","A4 q","G4 q","F4 q","E4 q","C4 h","G4 h","C4 e","D4 e","E4 q","G4 q","D5 q","E5 q","D5 q","C5 e","B4 e","A4 q","A4 q","G4 q","F4 q","E4 q","C4 w"],q=["C2 h","G3 h","C2 h","E2 h","F3 h","C3 h","C2 w","C2 q","E3 q","G3 q","G3 q","G3 q","G3 q","E3 q","C2 q","C2 q","E3 q","G3 q","G3 q","C2 w"];p=[...d,"E4 q","G4 q","A4 q","C5 q","B4 h","A4 q","G4 q","F4 q","E4 q","D4 q","E4 q","A4 w",...d],f=[...q,"A3 h","E3 h","E3 h","A3 h","F3 h","E3 h","A3 w",...q];let w=new h(c,u,p),m=new h(c,u,[]),b=new h(c,u,f);w.staccato=.55,b.staccato=.6,b.smoothing=.01,w.gain.gain.value=.07,m.gain.gain.value=.07,b.gain.gain.value=.024,w.eqs.mid.frequency.value=800,w.eqs.mid.gain.value=3,b.eqs.bass.gain.value=6,b.eqs.bass.frequency.value=80,b.eqs.mid.gain.value=-6,b.eqs.mid.frequency.value=500,b.eqs.treble.gain.value=-2,b.eqs.treble.frequency.value=1400;let _=["G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h"],k=["G3 h","D3 h","G3 h","D3 h","B3 h","D3 h","D3 h","G3 h","C3 h","D3 h","G3 h","E3 h","A3 h","D3 h","G3 h","D3 q"],g=[..._,..._,"E4 q","F#4 q","G4 h","G4 h","A4 q","B4 q","C5 q","B4 q","A4 h","A4 h","F#4 q","G4 q","E4 q","F#4 q","A4 q","G4 q","F#4 h","G4 q","B4 q","C5 h","A4 h","D5 q","C4 q","B3 h",..._],v=[...k,...k,"E3 h","D3 h","G3 h","C3 h","A3 h","C3 h","B3 h","D3 h","D3 h","B3 h","D3 h","B3 h","C3 h","G3 h","E3 h","G3 q",...k],y=new h(c,u,g),C=new h(c,u,v);function E(){y.stop(),C.stop(),G.stop(),x.stop(),w.stop(),m.stop(),b.stop()}y.staccato=.55,C.staccato=.6,C.smoothing=.01,y.gain.gain.value=.07,C.gain.gain.value=.024,y.eqs.mid.frequency.value=800,y.eqs.mid.gain.value=3,C.eqs.bass.gain.value=6,C.eqs.bass.frequency.value=80,C.eqs.mid.gain.value=-6,C.eqs.mid.frequency.value=500,C.eqs.treble.gain.value=-2,C.eqs.treble.frequency.value=1400;let A=[],M=[],B=["A4 q","B4 q","C4 h","D4 q","D#4 q","E4 h","G4 q","F#4 q","E4 h","C4 q","D4 q","B4 h","E4 q","F#4 q","G#4 h","A4 hs","- q","C4 q","B4 q","G4 h","A4 w"];A=[...B,...B,"E4 q","F#4 q","G#4 h","A4 h","B4 q","A4 q","C4 qs","D4 e","F#4 q","E4 q","G4 h","A4 h","B4 q","A4 q","G#4 q","E4 q","F4 h","D#4 q","E4 q","C4 hs","- q","A4 q","- q","- h",...B];let P=["A3 q","E3 q","A3 q","C3 q","E3 q","G#3 q","B3 q","D3 q","D3 q","A3 q","F#3 h","B3 q","F3 q","D3 h","F3 q","C3 q","F3 h","A3 q","C#3 q","E3 h","G3 q","D3 q","G3 h","A3 q","E3 q","A3 q","C3 q"];M=[...P,...P,"C3 q","B3 q","F3 q","D3 q","E3 q","G#3 q","B3 q","D3 q","A3 q","C3 q","E3 h","F3 q","A3 q","C3 h","D3 q","A3 q","F3 h","E3 q","G#3 q","B3 h","A3 q","E3 q","A3 q","C3 q","A3 h","A3 h",...P];let G=new h(c,u,A),x=new h(c,u,M);G.gain.gain.value=.07,x.gain.gain.value=.024,G.staccato=.55,x.staccato=.6,x.smoothing=.01;const $=e=>Math.sin(e),F=e=>(e%6.28-3.14)/6.28,D=e=>{return t=1e3*Math.sin(e),o=-1,i=1,Math.max(Math.min(t,i),o);var t,o,i};async function L(e,t){let o=c.sampleRate,i=c.createBuffer(1,o*e,o),n=i.getChannelData(0),s=i.length;for(let r=0;r<s;r++)n[r]=t(44100*r/o)*(1-r/s)*.4;return await async function(){return new Promise(e=>setTimeout(e,0))}(),i}function K(e){let t=c.createBufferSource();t.buffer=e,t.connect(c.destination),t.start()}const R=()=>Math.random();let T=await L(.3,e=>.1*$(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440)*.1)),I=await L(.2,e=>.1*D(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440*e/100)*.1)),j=await L(3,e=>e/44100%.2<.1?.5*$(.05*R()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(2*F(e/44100*2*Math.PI*840)*Math.PI*340/44100):.1*$(2*e*Math.PI*840/44100)),z=await L(4,e=>e/44100%.04<.02?.1*D(2*e*Math.PI*(840*e/.4)/44100):e/44100<.6?.2*D(2*F(e/44100*2*Math.PI*(e/500+340))*Math.PI*340/44100):.1*D(2*e*Math.PI*(e/10500+660)/44100));const S={drop:await L(.12,e=>e/44100%.2<.1?.5*$(.05*R()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(e/44100*2*Math.PI*(100+.1*e)):.1*$(2*e*Math.PI*840/44100)),correct:j,next:I,chapter:T,done_chapter:z},O=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),N=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,Q=e=>N(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class V{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new V(0,1<<e-32):new V(1<<e,0)}static fromRank(e){return new V(255,0).shl64(8*e)}static fromFile(e){return new V(16843009<<e,16843009<<e)}static empty(){return new V(0,0)}static full(){return new V(4294967295,4294967295)}static corners(){return new V(129,2164260864)}static center(){return new V(402653184,24)}static backranks(){return new V(255,4278190080)}static backrank(e){return"white"===e?new V(255,0):new V(0,4278190080)}static lightSquares(){return new V(1437226410,1437226410)}static darkSquares(){return new V(2857740885,2857740885)}complement(){return new V(~this.lo,~this.hi)}xor(e){return new V(this.lo^e.lo,this.hi^e.hi)}union(e){return new V(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new V(this.lo&e.lo,this.hi&e.hi)}diff(e){return new V(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?V.empty():e>=32?new V(this.hi>>>e-32,0):e>0?new V(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?V.empty():e>=32?new V(0,this.lo<<e-32):e>0?new V(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new V(N(this.hi),N(this.lo))}rbit64(){return new V(Q(this.hi),Q(this.lo))}minus64(e){const t=this.lo-e.lo,o=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new V(t,this.hi-(e.hi+o))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return O(this.lo)+O(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new V(this.lo,this.hi|1<<e-32):new V(this.lo|1<<e,this.hi)}without(e){return e>=32?new V(this.lo,this.hi&~(1<<e-32)):new V(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new V(this.lo,this.hi^1<<e-32):new V(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new V(this.lo&this.lo-1,this.hi):new V(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||!!(this.lo&this.lo-1)||!!(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}const X=e=>e>>3,U=e=>7&e,W=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Y=(e,t)=>{let o=V.empty();for(const i of t){const t=e+i;0<=t&&t<64&&Math.abs(U(e)-U(t))<=2&&(o=o.with(t))}return o},Z=e=>{const t=[];for(let o=0;o<64;o++)t[o]=e(o);return t},H=Z(e=>Y(e,[-9,-8,-7,-1,1,7,8,9])),J=Z(e=>Y(e,[-17,-15,-10,-6,6,10,15,17])),ee={white:Z(e=>Y(e,[7,9])),black:Z(e=>Y(e,[-7,-9]))},te=Z(e=>V.fromFile(U(e)).without(e)),oe=Z(e=>V.fromRank(X(e)).without(e)),ie=Z(e=>{const t=new V(134480385,2151686160),o=8*(X(e)-U(e));return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),ne=Z(e=>{const t=new V(270549120,16909320),o=8*(X(e)+U(e)-7);return(o>=0?t.shl64(o):t.shr64(-o)).without(e)}),se=(e,t,o)=>{let i=o.intersect(t),n=i.bswap64();return i=i.minus64(e),n=n.minus64(e.bswap64()),i.xor(n.bswap64()).intersect(t)},re=(e,t)=>{const o=V.fromSquare(e);return se(o,ie[e],t).xor(se(o,ne[e],t))},ae=(e,t)=>((e,t)=>se(V.fromSquare(e),te[e],t))(e,t).xor(((e,t)=>{const o=oe[e];let i=t.intersect(o),n=i.rbit64();return i=i.minus64(V.fromSquare(e)),n=n.minus64(V.fromSquare(63-e)),i.xor(n.rbit64()).intersect(o)})(e,t)),le=(e,t,o)=>{switch(e.role){case"pawn":return((e,t)=>ee[e][t])(e.color,t);case"knight":return(e=>J[e])(t);case"bishop":return re(t,o);case"rook":return ae(t,o);case"queen":return((e,t)=>re(e,t).xor(ae(e,t)))(t,o);case"king":return(e=>H[e])(t)}};function he(e){return function(e){let t=[],o=function(e){let t=[],o=function(e){let t=V.empty();for(let o of Object.keys(e))t=t.set(e[o],!0);return t}(e);for(let i of Object.keys(e)){let n=we(i),s=e[i],r=le(n,s,o);for(let a of r)for(let l of Object.keys(e))if(e[l]===a){let a,h=e[l],c=o.without(h),u=le(n,s,c).diff(r);for(let t of u)for(let o of Object.keys(e))e[o]===t&&(a=o);void 0!==a?t.push([i,l,a]):t.push([i,l])}}return t.sort((e,t)=>e.join(" ").localeCompare(t.join(" "))),t}(e);for(let i of Object.keys(e)){let e=[],n=[],s=[],r=[],a=[];for(let t of o)t[0]===i?2===t.length?e.push(t[1]):r.push([t[1],t[2]]):t[1]===i?2===t.length?n.push(t[0]):s.push([t[0],t[2]]):t[2]===i&&a.push([t[0],t[1]]);t.push({p1:i,attacks:e,attacked_by:n,blocks:s,blocked_attacks:r,blocked_attacked_by:a})}return t}(fe(e))}const ce=e=>!e.attacked_by.find(e=>e.toLowerCase()===e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()===e[0])&&!e.blocks.find(e=>e[0].toLowerCase()===e[0]),ue=e=>!e.attacked_by.find(e=>e.toLowerCase()!==e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()!==e[0])&&!e.blocks.find(e=>e[0].toLowerCase()!==e[0]);function pe(e){let t=e.p1,o=e.attacks.map(e=>`+${e}`).join(" "),i=e.attacked_by.map(e=>`${e}+`).join(" "),n=e.blocks.map(e=>`${e[0]}+|${e[1]}`).join(" "),s=e.blocked_attacks.map(e=>`+${e[0]}/${e[1]}`).join(" "),r=e.blocked_attacked_by.map(e=>`${e[0]}+/${e[1]}`).join(" "),a=[t];return ce(e)&&a.push("z+"),ue(e)&&a.push("Z+"),""!==o&&a.push(o),""!==i&&a.push(i),""!==n&&a.push(n),""!==s&&a.push(s),""!==r&&a.push(r),a.join(" ")}function fe(e){e=e.split(" ")[0];let t={},o=7;for(let i of e.split("/")){let e=0;for(let n of i)if(qe(n)){let i=W(e,o);if(void 0!==i){let e=n,o=2;for(;void 0!==t[e];)e=n+o,o++;t[e]=i}e+=1}else e+=parseInt(n);o-=1}return t}const de={r:"rook",n:"knight",b:"bishop",p:"pawn",q:"queen",k:"king"};function qe(e){return void 0!==de[e.toLowerCase()]}function we(e){var t;return{color:(t=e).toLowerCase()===t?"black":"white",role:de[e.toLowerCase().replace(/[2345678]/,"")]}}let me;console.log(he("8/8/4r3/r1n5/1k1B4/6Np/1PP1n3/2KRR3 w - - 0 1").map(pe));const be=()=>{let{chapter:e}=ft[pt];me!==e&&(E(),setTimeout(()=>{0===e?function(){let e=c.currentTime;y.play(e),C.play(e)}():1===e?function(){let e=c.currentTime;G.play(e),x.play(e)}():2===e&&function(){let e=c.currentTime;w.play(e),b.play(e)}(),me=e},1e3))};let _e,ke,ge,ve,ye=await function(e){let t=new Image;return new Promise(o=>{t.onload=()=>o(t),t.src=e})}(e);function Ce(e,t,o,i=1,n=i){let s,r,a;t=Math.floor(t),o=Math.floor(o),e<4?(s=32,r=32*e,a=0):e<28?(s=16,r=(e-=4)%8*16,a=32+16*Math.floor(e/8)):(s=8,r=(e-=28)%16*8,a=80+8*Math.floor(e/16)),ke.drawImage(ye,r,a,s,s,t,o,s*i,s*n)}function Ee(e){ve.font="42px Arial",ve.shadowColor="black",ve.shadowBlur=4;let t=1308,o=803.25;Ae(e[0],t,o,600,60),ve.font="28px Arial",t=1308,o=1039.5,Ae(e[1],t,o,600,60)}function Ae(e,t,o,i,n){const s=e.split(" ");let r="",a=o;for(let l=0;l<s.length;l++){const e=r+s[l]+" ";ve.measureText(e).width>i&&l>0?(ve.fillText(r,t,a),r=s[l]+" ",a+=n):r=e}ve.fillText(r,t,a)}function Me(){ve.clearRect(0,0,1920,1080),ke.fillRect(0,0,320,180),Ce(110,0,0,320);let e=10,t=24;for(let i=0;i<8;i++)for(let o=0;o<8;o++){Ce(108+((i+o)%2==1?1:0),e+3.5*i*8,t+3.5*o*8,3.5)}e=10,t=0,Ce(111,e,t,28,3),t=248,Ce(111,e,t,28,3);for(let i of ht)Ce(We(i.piece),...i.pos,3),i.piece.match(/2/)&&Ce(82,...i.pos,3),i.is_hovering&&Ce(112,...i.pos,3);Ce(111,318,188,20,10),Ee(_t||(mt||(bt||wt))),Ce(111,238,2,30,23);let o=at.find(e=>e.is_hovering);if(o){let[e,t,i,n]=o.bb;ke.strokeRect(e,t,i,n);for(let s of o.circles)Ce(112,...s,3);for(let s of o.no_arrows)Ie(s[0],s[1],"red");for(let s of o.yes_arrows)Ie(s[0],s[1],"green")}for(let i of rt)Ce(i[0],i[1],i[2]);if(lt&&Ce(We(lt.piece),...lt.pos,3),void 0!==mt){!function(e,t,o,i){for(let n=0;n<t;n++)Ce(e+n,o+8*n*2,i,2)}(119,5,400,246+(vt&&kt%500<200?2:0))}if(function(){let e=Re,t=Te;Ce(111,238,188,9.8,10);let o=ft[pt];ve.font="bold 64px Arial",ve.fillText(`${o.chapter}-${o.level}`,265*e,204*t);let i=kt%500<250?3:0,n=Ct?i:0;Ce(117,242-(yt?i:0),190,2),Ce(118,296+n,190,2),Ce(Ge+(ft[pt].is_revealed?16:ft[pt].is_solved?8:0),250,214,3),Ce(void 0===Mt||Mt?116:115,298,214,2)}(),Ce(28,...ut),Et){let e=80*Math.sin(.008*kt),t=80*Math.sin(.008*kt),o=80*Math.sin(.003*kt);ve.font="bold 180px Arial",ve.shadowColor="purple",ve.shadowBlur=10,ve.lineWidth=4,ve.strokeStyle="purple",ve.strokeText("Mor",200+e,400+t),ve.strokeText("Chess",1e3-e,400+t),ve.fillStyle="white",ve.shadowBlur=0,ve.fillText("Mor",200+e,400+t),ve.fillText("Chess",1e3-e,400+t),ve.fillStyle="black",ve.fillText("Black",200,800-.1*o),ve.fillText("Cat",800,800-.1*o)}}let Be,Pe,Ge,xe,$e=[250,214,48,48],Fe=[298,214,16,16];const De={neutral:4,happy:5,sad:6,angry:7,surprised:8,sleepy:9,playful:10},Le=[242,190,16,16],Ke=[296,190,16,16],Re=4,Te=4;function Ie(e,t,o){ve.lineWidth=10,ve.strokeStyle=o,ve.lineCap="round",ve.beginPath(),ve.moveTo(e[0]*Re,e[1]*Te),ve.lineTo(t[0]*Re,t[1]*Te),ve.stroke()}const je=[400,246,80,16];function ze(e,t){return pe(e)===pe(t)}const Se=(e,t,o)=>rt.push([e,t,o,0]),Oe=(e,t,o,i,n,s,r,a)=>at.push({info:e,bb:[t,o,i,n],is_hovering:!1,circles:s,yes_arrows:r,no_arrows:a});function Ne(e,t,o){const i=e=>ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos),n=(e,t)=>{let o=ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos)[0],i=ht.filter(e=>e.piece===t&&void 0!==Je(e.pos)).map(e=>e.pos)[0];if(o&&i){return[[[o[0]+12,o[1]+12],[i[0]+12,i[1]+12]]]}return[]};let s=[],r=[],a=[];const l=(e,t,o,i,n)=>{Oe(e,t,o,i,n,s,r,a),s=[],r=[],a=[]},h=Se;h(We(e.p1),t+4,o+4),e.p1.match(/2/)&&h(82,t+4,o+4),s=i(e.p1),l(Qe.yes_piece(e.p1),t+2,o+2,12,12),h(39,(t+=8)+4,o+4),t+=8;let c=tt();if(ce(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()===e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()===e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(33,t+4,o+4):h(32,t+4,o+4),s=i(e.p1),l(Qe.zero_attacked_by_lower(e.p1),t+2,o+2,12,12),t+=12}if(ue(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()!==e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()!==e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(32,t+4,o+4):h(33,t+4,o+4),s=i(e.p1),l(Qe.zero_attacked_by_upper(e.p1),t+2,o+2,12,12),t+=12}for(let u of e.attacks){h(35,t+2,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.attacks.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],l(Qe.attacks(e.p1,u),t+4,o+2,14,12),t+=5,h(We(u),t+4,o+4),u.match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.attacked_by){h(We(u),t+4,o+4),u.match(/2/)&&h(82,t+4,o+4);let p=c.find(t=>t.p1===e.p1);0===(p?.attacked_by.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],s=i(e.p1),l(Qe.attacked_by(e.p1,u),t+4,o+2,14,12),h(34,(t+=9)+2,o+4),t+=5}for(let u of e.blocks){h(We(u[1]),t+4,o+4),u[1].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.blocks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(u[0],u[1])],l(Qe.blocks(e.p1,...u),t+4,o+2,24,12),h(36,(t+=9)+2,o+4),t+=5,h(We(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.blocked_attacks){h(We(u[1]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1);0===(i?.blocked_attacks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(e.p1,u[1])],l(Qe.blocked_attacks(e.p1,u[1],u[0]),t+4,o+2,24,12),h(37,(t+=9)+2,o+4),t+=5,h(We(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}for(let u of e.blocked_attacked_by){h(We(u[1]),t+4,o+4),u[1].match(/2/)&&h(82,t+4,o+4);let i=c.find(t=>t.p1===e.p1),s=i?.blocked_attacked_by.filter(e=>e[0]===u[0]&&e[1]===u[1])??[];0===s.length?a=[...n(u[0],u[1]),...n(e.p1,u[0])]:r=[...n(e.p1,u[0])],s=i?.attacked_by.filter(e=>e===u[0]).map(e=>[e,e])??[],s=s.concat(i?.blocks.filter(e=>e[0]===u[0])??[]),s.length>0&&(a=[...n(e.p1,u[0])]),l(Qe.blocked_attacked_by(e.p1,u[0],u[1]),t+4,o+2,24,12),h(38,(t+=9)+2,o+4),t+=5,h(We(u[0]),t+4,o+4),u[0].match(/2/)&&h(82,t+4,o+4),t+=9}return[t,o]}const Qe={welcome0:["welcome to mor chess; drag pieces onto the board, but there are some rules above. hover over them for details.","drag a piece off the board to remove it."],welcome1:["each chapter; proressively reveals more pieces of a single position.","call out the cat 3 times, if you get in a mess ;)"],welcome2:["chess tactics; are born out of relationships.","our job is to entangle them."],welcome3:["rules are tools to an end.","look here, just enough to keep the cats happy."],well_done:["Congratulations, you satisfied all rules. Time to go deeper.","Click Next to continue."],well_end:["the end; chess is fascinating isn't it, go play some chess.","Thank's for playing"],equals:e=>["left side is the goal, right side is the board; your goal is to match them equal.",`this rule ${e?"has matched correctly.":"has not been matched yet."}`],no_piece:e=>[`${Ue(e)} hasn't been placed yet.`,""],yes_piece:e=>[`A ${Ue(e)} on the board.`,""],zero_attacked_by_lower(e){let t=e.toLowerCase()===e?"defenders":"attackers";return[`${Ue(e)} has zero ${t}.`,""]},zero_attacked_by_upper(e){let t=e.toLowerCase()===e?"attackers":"defenders";return[`${Ue(e)} has zero ${t}.`,""]},attacks(e,t){let o=Ue(e),i=Ue(t);return[`${o} is ${Ve(e,t)} ${i}.`,`${i} shouldn't be blocking an attack of ${o}.`]},attacked_by(e,t){let o=Ue(e),i=Ue(t);return[`${o} is ${Xe(e,t)} by ${i}.`,""]},blocks(e,t,o){let i=Ue(e),n=Ue(t),s=Ue(o);return[`${i} blocks ${n} ${Ve(t,o)} ${s}.`,""]},blocked_attacks(e,t,o){let i=Ue(e),n=Ue(t),s=Ue(o);return[`${i} is ${Ve(e,t)} ${n}, but that's blocked by ${s}.`,""]},blocked_attacked_by(e,t,o){let i=Ue(e),n=Ue(t),s=Ue(o);return[`${i} is ${Xe(e,t)} by ${n}, but that's blocked by ${s}.`,""]}},Ve=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defending":"attacking",Xe=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defended":"attacked";function Ue(e){let t=we(e),o=e.match(/2/)?"2":"";return t.role[0].toUpperCase()+t.role.slice(1)+o}function We(e){let t=we(e);return 76+{pawn:0,rook:1,bishop:2,knight:3,queen:4,king:5}[t.role]+("white"===t.color?16:0)}function Ye(e){if(xe-=e,xe<0&&(xe=0),xe>1e3&&(xe=0,ft[pt].is_revealed||(ft[pt].is_revealed=!0,function(){Bt();let e=fe(ft[pt].fen);for(let t of Object.keys(e)){let o=U(e[t]),i=X(e[t]);ht.push(nt(t,He([o,7-i])))}st=!0}())),Pe-=e,kt+=e,Pe<0&&(Ge=kt%1e4<2e3?De.sleepy:De.neutral),ct.is_hovering){ut=ct.is_hovering;for(let e of ht)e.is_hovering=!1;for(let e of ht)if(t(it(e),ot(ut))){e.is_hovering=!0;break}if(void 0!==lt)lt.pos=[ut[0]-4,ut[1]-4];else{for(let e of at)e.is_hovering=!1;for(let e of at)t(e.bb,ot(ut))&&(e.is_hovering=!0)}gt=t($e,ot(ut)),vt=void 0!==mt&&t(je,ot(ut)),yt=t(Le,ot(ut)),Ct=t(Ke,ot(ut)),gt&&Pe<0&&(Ge=De.playful,Pe=260)}if(ct.is_just_down){let e=ht.find(e=>e.is_hovering);if(e){e.is_dragging=!0,lt=nt(e.piece,e.pos),Je(e.pos)&&(lt.orig=e)}}if(ct.is_up){if(void 0!==Mt||At||(Mt=!1,be()),lt){if(lt.orig){let e=lt.orig.pos;ht=ht.filter(t=>!(t.pos[0]===e[0]&&t.pos[1]===e[1]))}let e=Je(ct.is_up);if(e){let t=He(e);ht=ht.filter(e=>!(e.pos[0]===t[0]&&e.pos[1]===t[1])),ht.push(nt(lt.piece,t))}!function(){for(let e of ht){let t=Je(e.pos);if(!t)continue;let o=ht.find(o=>{if(o!==e&&o.piece[0]===e.piece[0]){let e=Je(o.pos);if(e){let o=W(...t);if(W(...e)<o)return!0}}})?"2":"";e.piece=e.piece[0]+o}}(),lt=void 0,st=!0,Ge=De.surprised,Pe=3e3,K(S.drop)}vt&&(pt===ft.length-1?Ze(0):Ze(1)),yt&&Ze(-1),Ct&&Ze(1),t(Fe,ot(ct.is_up))&&(Mt=!Mt,Mt?E():be()),gt&&(Ge=De.sad,Pe=1e3,xe+=540)}if(st){st=!1,rt=[],at=[];let e=qt(),t=tt(),o=0,i=!0,n=2;for(let s of e){let e=238;[e,n]=Ne(s,e,n);let r=t.find(e=>e.p1===s.p1),a=void 0!==r&&ze(s,r)?30:29;30===a&&o++,i=i&&30===a,Se(a,e+4,n+4),Oe(Qe.equals(30===a),e+2,n+2,12,12,[],[],[]),e+=10,void 0===r?(Se(31,e+4,n+4),Oe(Qe.no_piece(s.p1),e+2,n+2,12,12,[],[],[])):[e,n]=Ne(r,e,n),n+=14,e=182}Be>o&&(Ge=De[Math.random()<.8?"angry":"sad"],Pe=1500),Be=o,i?function(){ft[pt].is_solved=!0,ft.filter(e=>e.chapter===ft[pt].chapter).every(e=>e.is_solved)?K(S.done_chapter):K(S.correct);Ge=De.playful,Pe=5e3,pt<ft.length-1?-1===ft.findIndex(e=>!e.is_solved)?Et=!0:mt=Qe.well_done:-1===ft.findIndex(e=>!e.is_solved)?Et=!0:mt=Qe.well_end}():mt=void 0}if(bt=at.find(e=>e.is_hovering)?.info,ct.update(e),Et){for(let t of ht)t.pos[1]-=.1*e*Math.random(),t.pos[1]<-20&&(t.pos[1]=400);kt%500<17&&(pt+=1,pt>ft.length-1&&(pt=0),st=!0)}}function Ze(e){be(),ft[pt].is_revealed&&(ft[pt].is_revealed=!1,ft[pt].is_solved=!1);let t=pt+e;if(0===e&&(t=ft.findIndex(e=>!e.is_solved)),t<0||t>=ft.length)return;let o=ft[t].chapter!==ft[pt].chapter;o?(K(S.chapter),Bt()):K(S.next),st=!0,pt=t,o&&(wt=Qe[`welcome${ft[pt].chapter}`],Ge=De.surprised,Pe=5e3)}function He(e){return[10+3.5*e[0]*8+2,24+3.5*e[1]*8+4]}function Je(e){let[t,o]=e;if(t-=10,o-=24,!(t<0||t>=224||o<0||o>=224))return t=Math.floor(t/28),o=Math.floor(o/28),[t,o]}function et(e){return he(e)}function tt(){return et(function(){let e={};for(let o of ht){let t=Je(o.pos);if(t){let i=o.piece;e[W(...t)]=i}}let t="";for(let o=0;o<8;o++){let i=0;for(let n=0;n<8;n++){let s=W(n,o);e[s]?(i>0&&(t+=i),t+=e[s][0],i=0):i++}i>0&&(t+=i),t+="/"}return t}())}function ot(e){return[e[0]+1,e[1]+1,6,6]}function it(e){let[t,o]=e.pos;return[t,o,24,24]}function nt(e,t){return{piece:e,pos:t,is_hovering:!1,is_dragging:!1}}let st,rt,at,lt,ht,ct,ut,pt,ft=[dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",0,0),dt("6k1/8/8/8/8/8/5P2/6K1 w - - 0 1",0,1),dt("6k1/8/8/8/8/8/6PP/6K1 w - - 0 1",0,2),dt("6k1/8/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,3),dt("6k1/b7/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,4),dt("1r4k1/bP6/8/8/8/5B2/5P2/6K1 w - - 0 1",0,5),dt("1r4k1/bP6/4p3/3r4/8/5B2/5P2/6K1 w - - 0 1",0,6),dt("1r4k1/bP6/4p3/p2r4/8/5B2/5P2/R5K1 w - - 0 1",0,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",1,0),dt("8/1K6/4b3/8/3r4/4k3/8/8 w - - 0 1",1,1),dt("8/1K6/4b3/4R3/3rP3/4k3/8/8 w - - 0 1",1,2),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",2,0),dt("8/5k2/8/8/8/8/6PP/6K1 w - - 0 1",2,1),dt("8/5k2/4rn2/8/8/8/6PP/6K1 w - - 0 1",2,2),dt("8/5k2/8/8/8/8/8/R2R2K1 w - - 0 1",2,3),dt("3r4/5k2/8/8/3n4/8/8/3R2K1 w - - 0 1",2,4),dt("3r4/6k1/5rn1/8/3n4/8/6PP/3R2K1 w - - 0 1",2,5),dt("3r4/6k1/5rn1/1p6/2Nn4/8/6PP/R2R2K1 w - - 0 1",2,6),dt("3r4/5k2/4rn2/1p6/2N5/3n4/1B4PP/R2R2K1",2,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",3,0),dt("6k1/8/8/8/8/8/7q/1K1Q4 w - - 0 1",3,1),dt("6k1/7p/8/8/8/8/2Pr3q/1K1QR3 w - - 0 1",3,2),dt("6k1/7p/8/6p1/8/8/1PPr3q/1K1QR3 w - - 0 1",3,3)];function dt(e,t,o){return{chapter:t,level:o,fen:e,is_solved:!1,is_revealed:!1}}const qt=()=>et(ft[pt].fen);let wt,mt,bt,_t,kt,gt,vt,yt,Ct,Et,At,Mt;function Bt(){ht=[nt("p",[20,0]),nt("n",[52,0]),nt("b",[84,0]),nt("r",[116,0]),nt("q",[148,0]),nt("k",[180,0]),nt("P",[20,248]),nt("N",[52,248]),nt("B",[84,248]),nt("R",[116,248]),nt("Q",[148,248]),nt("K",[180,248])]}!function(e){_e=document.createElement("canvas"),_e.width=480,_e.height=270,_e.classList.add("pixelated"),ke=_e.getContext("2d"),ke.imageSmoothingEnabled=!1,ke.fillStyle="black",ge=document.createElement("canvas"),ge.width=1920,ge.height=1080,ve=ge.getContext("2d");let t=document.createElement("div");t.classList.add("content"),t.appendChild(_e),t.appendChild(ge),e.appendChild(t),xe=0,At&&E(),At=!1,Be=0,Ge=De.happy,Pe=5e3,Et=!1,yt=!1,Ct=!1,vt=!1,kt=0,_t=void 0,mt=void 0,bt=void 0,wt=Qe.welcome0,st=!0,rt=[],at=[],pt=0,lt=void 0,ht=[],Bt(),ct=o(_e),ut=[0,0],function(e,t){const o=1e3/60;let i=performance.now(),n=0;requestAnimationFrame(function s(r){requestAnimationFrame(s);let a=Math.min(r-i,1e3);for(i=r,n+=a;n>=o;)e(o),n-=o;t(n/o)})}(Ye,Me)}(document.getElementById("app"));
