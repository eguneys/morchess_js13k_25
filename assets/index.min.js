const e=""+new URL("sprites_with_bg_alpha_working-BxZTOugz.png",import.meta.url).href;function t(e,t){let[i,o,n,s]=e,[r,a,l,h]=t;return i<r+l&&i+n>r&&o<a+h&&o+s>a}function i(e){let t,i,o,n,s,r=!1,a=0;function l(t){return[t[0]*e.width,t[1]*e.height]}return function(e,t){const i=e=>{let[t,i]=(e=>{if(e.clientX||0===e.clientX)return[e.clientX,e.clientY]})(e)??[0,0];return[(t-o.left)/o.width,(i-o.top)/o.height]};let o,n=e.getContext("2d");function s(){o=e.getBoundingClientRect(),n.imageSmoothingEnabled=!1}function r(){s()}s(),e.addEventListener("pointerdown",function(o){e.setPointerCapture(o.pointerId);let n=i(o);t.on_down(n)},{passive:!1}),e.addEventListener("pointermove",function(e){let o=i(e);t.on_move(o)},{passive:!1}),document.addEventListener("pointerup",function(e){let o=i(e);t.on_up(o)}),new ResizeObserver(s).observe(e),document.addEventListener("scroll",r,{capture:!0,passive:!0}),window.addEventListener("resize",r,{passive:!0})}(e,{on_down(e){e=l(e),o=void 0,i=e,n=e,r=!1},on_up(e){e=l(e),i=void 0,t=void 0,o=e},on_move(e){e=l(e),t=e,r=!0}}),{get is_hovering(){return t},get is_down(){return i},get is_up(){return o},get is_just_down(){return n},get is_double_click(){return s},get has_moved_after_last_down(){return r},update(e){var t,i,r;s=void 0,n&&a>0&&(s=n,a=0),r=e,a=(t=a)<(i=0)?Math.min(t+r,i):t>i?Math.max(t-r,i):t,n=void 0,o=void 0}}}let o=440*Math.pow(Math.pow(2,1/12),-9),n=/^[0-9.]+$/,s=/\s+/,r=/(\d+)/,a={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(e,t){e.split("-").forEach(function(e){a[e]=t})});class l{frequency;duration;constructor(e){let t=e.split(s);var i;this.frequency=function(e){var t=e.split(r),i=a[t[0]],n=(parseInt(t[1])||4)-4;return o*Math.pow(Math.pow(2,1/12),i)*Math.pow(2,n)}(t[0])||0,this.duration=(i=t[1],(n.test(i)?parseFloat(i):i.toLowerCase().split("").reduce(function(e,t){return e+("w"===t?4:"h"===t?2:"q"===t?1:"e"===t?.5:"s"===t?.25:0)},0))||0)}}class h{cx;tempo;notes;loop;smoothing;staccato;eqs;gain;osc;wave_type;constructor(e,t=120,i=[],o=!0){this.cx=e,this.tempo=t,this.osc=null,this.create_fx_nodes(),this.loop=o,this.smoothing=0,this.staccato=0,this.notes=[],this.push(i)}push(e){this.notes.push(...e.map(e=>new l(e)))}create_fx_nodes(){var e=this.gain=this.cx.createGain();return this.eqs={bass:void 0,mid:void 0,treble:void 0},[["bass",100],["mid",1e3],["treble",2500]].forEach(t=>{let i=this.eqs[t[0]]=this.cx.createBiquadFilter();i.type="peaking",i.frequency.value=t[1],e.connect(e=i)}),e.connect(this.cx.destination),this}create_oscillator(){return this.stop(),this.osc=this.cx.createOscillator(),this.osc.type=this.wave_type||"square",this.osc.connect(this.gain),this}schedule_note(e,t){var i=60/this.tempo*this.notes[e].duration,o=i*(1-(this.staccato||0));return this.set_frequency(this.notes[e].frequency,t),this.smoothing&&this.notes[e].frequency&&this.slide(e,t,o),this.set_frequency(0,t+o),t+i}get_next_note(e){return this.notes[e<this.notes.length-1?e+1:0]}get_slide_start_delay(e){return e-Math.min(e,60/this.tempo*this.smoothing)}slide(e,t,i){var o=this.get_next_note(e),n=this.get_slide_start_delay(i);return this.set_frequency(this.notes[e].frequency,t+n),this.ramp_frequency(o.frequency,t+i),this}set_frequency(e,t){return this.osc.frequency.setValueAtTime(e,t),this}ramp_frequency(e,t){return this.osc.frequency.linearRampToValueAtTime(e,t),this}play(e){return e="number"==typeof e?e:this.cx.currentTime,this.create_oscillator(),this.osc.start(e),this.notes.forEach((t,i)=>{e=this.schedule_note(i,e)}),this.osc.stop(e),this.osc.onended=this.loop?()=>this.play(e):null,this}stop(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this}}let c=new AudioContext,u=96,f=[],p=[],d=["C4 q","E4 q","G4 q","C5 q","E5 q","D5 q","C5 q","G4 q","A4 q","G4 q","F4 q","E4 q","C4 h","G4 h","C4 e","D4 e","E4 q","G4 q","D5 q","E5 q","D5 q","C5 e","B4 e","A4 q","A4 q","G4 q","F4 q","E4 q","C4 w"],q=["C2 h","G3 h","C2 h","E2 h","F3 h","C3 h","C2 w","C2 q","E3 q","G3 q","G3 q","G3 q","G3 q","E3 q","C2 q","C2 q","E3 q","G3 q","G3 q","C2 w"];f=[...d,"E4 q","G4 q","A4 q","C5 q","B4 h","A4 q","G4 q","F4 q","E4 q","D4 q","E4 q","A4 w",...d],p=[...q,"A3 h","E3 h","E3 h","A3 h","F3 h","E3 h","A3 w",...q];let w=new h(c,u,f),m=new h(c,u,[]),b=new h(c,u,p);w.staccato=.55,b.staccato=.6,b.smoothing=.01,w.gain.gain.value=.07,m.gain.gain.value=.07,b.gain.gain.value=.024,w.eqs.mid.frequency.value=800,w.eqs.mid.gain.value=3,b.eqs.bass.gain.value=6,b.eqs.bass.frequency.value=80,b.eqs.mid.gain.value=-6,b.eqs.mid.frequency.value=500,b.eqs.treble.gain.value=-2,b.eqs.treble.frequency.value=1400;let k=["G4 q","A4 q","B4 h","B4 h","A4 q","F#4 q","F#4 h","F#4 h","A4 h","G4 q","F#4 q","E4 q","D4 q","C4 q","F#4 q","G4 h","A4 q","B4 q","B4 q","B4 q","A4 h","B4 q","B4 q","F#4 h"],_=["G3 h","D3 h","G3 h","D3 h","B3 h","D3 h","D3 h","G3 h","C3 h","D3 h","G3 h","E3 h","A3 h","D3 h","G3 h","D3 q"],g=[...k,...k,"E4 q","F#4 q","G4 h","G4 h","A4 q","B4 q","C5 q","B4 q","A4 h","A4 h","F#4 q","G4 q","E4 q","F#4 q","A4 q","G4 q","F#4 h","G4 q","B4 q","C5 h","A4 h","D5 q","C4 q","B3 h",...k],v=[..._,..._,"E3 h","D3 h","G3 h","C3 h","A3 h","C3 h","B3 h","D3 h","D3 h","B3 h","D3 h","B3 h","C3 h","G3 h","E3 h","G3 q",..._],y=new h(c,u,g),C=new h(c,u,v);function E(){y.stop(),C.stop(),P.stop(),G.stop(),w.stop(),m.stop(),b.stop()}y.staccato=.55,C.staccato=.6,C.smoothing=.01,y.gain.gain.value=.07,C.gain.gain.value=.024,y.eqs.mid.frequency.value=800,y.eqs.mid.gain.value=3,C.eqs.bass.gain.value=6,C.eqs.bass.frequency.value=80,C.eqs.mid.gain.value=-6,C.eqs.mid.frequency.value=500,C.eqs.treble.gain.value=-2,C.eqs.treble.frequency.value=1400;let A=[],M=[],B=["A4 q","B4 q","C4 h","D4 q","D#4 q","E4 h","G4 q","F#4 q","E4 h","C4 q","D4 q","B4 h","E4 q","F#4 q","G#4 h","A4 hs","- q","C4 q","B4 q","G4 h","A4 w"];A=[...B,...B,"E4 q","F#4 q","G#4 h","A4 h","B4 q","A4 q","C4 qs","D4 e","F#4 q","E4 q","G4 h","A4 h","B4 q","A4 q","G#4 q","E4 q","F4 h","D#4 q","E4 q","C4 hs","- q","A4 q","- q","- h",...B];let x=["A3 q","E3 q","A3 q","C3 q","E3 q","G#3 q","B3 q","D3 q","D3 q","A3 q","F#3 h","B3 q","F3 q","D3 h","F3 q","C3 q","F3 h","A3 q","C#3 q","E3 h","G3 q","D3 q","G3 h","A3 q","E3 q","A3 q","C3 q"];M=[...x,...x,"C3 q","B3 q","F3 q","D3 q","E3 q","G#3 q","B3 q","D3 q","A3 q","C3 q","E3 h","F3 q","A3 q","C3 h","D3 q","A3 q","F3 h","E3 q","G#3 q","B3 h","A3 q","E3 q","A3 q","C3 q","A3 h","A3 h",...x];let P=new h(c,u,A),G=new h(c,u,M);P.gain.gain.value=.07,G.gain.gain.value=.024,P.staccato=.55,G.staccato=.6,G.smoothing=.01;const $=e=>Math.sin(e),F=e=>(e%6.28-3.14)/6.28,D=e=>{return t=1e3*Math.sin(e),i=-1,o=1,Math.max(Math.min(t,o),i);var t,i,o};async function L(e,t){let i=c.sampleRate,o=c.createBuffer(1,i*e,i),n=o.getChannelData(0),s=o.length;for(let r=0;r<s;r++)n[r]=t(44100*r/i)*(1-r/s)*.4;return await async function(){return new Promise(e=>setTimeout(e,0))}(),o}function T(e){let t=c.createBufferSource();t.buffer=e,t.connect(c.destination),t.start()}const K=()=>Math.random();let R=await L(.3,e=>.1*$(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440)*.1)),I=await L(.2,e=>.1*D(e/44100*2*Math.PI*440*F(e/44100*2*Math.PI*440*e/100)*.1)),j=await L(3,e=>e/44100%.2<.1?.5*$(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(2*F(e/44100*2*Math.PI*840)*Math.PI*340/44100):.1*$(2*e*Math.PI*840/44100)),z=await L(4,e=>e/44100%.04<.02?.1*D(2*e*Math.PI*(840*e/.4)/44100):e/44100<.6?.2*D(2*F(e/44100*2*Math.PI*(e/500+340))*Math.PI*340/44100):.1*D(2*e*Math.PI*(e/10500+660)/44100));const S={drop:await L(.12,e=>e/44100%.2<.1?.5*$(.05*K()+2*e*Math.PI*140/44100):e/44100<.6?.2*$(e/44100*2*Math.PI*(100+.1*e)):.1*$(2*e*Math.PI*840/44100)),correct:j,next:I,chapter:R,done_chapter:z},O=e=>(e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),N=e=>(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16,Q=e=>N(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4);class W{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new W(0,1<<e-32):new W(1<<e,0)}static fromRank(e){return new W(255,0).shl64(8*e)}static fromFile(e){return new W(16843009<<e,16843009<<e)}static empty(){return new W(0,0)}static full(){return new W(4294967295,4294967295)}static corners(){return new W(129,2164260864)}static center(){return new W(402653184,24)}static backranks(){return new W(255,4278190080)}static backrank(e){return"white"===e?new W(255,0):new W(0,4278190080)}static lightSquares(){return new W(1437226410,1437226410)}static darkSquares(){return new W(2857740885,2857740885)}complement(){return new W(~this.lo,~this.hi)}xor(e){return new W(this.lo^e.lo,this.hi^e.hi)}union(e){return new W(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new W(this.lo&e.lo,this.hi&e.hi)}diff(e){return new W(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?W.empty():e>=32?new W(this.hi>>>e-32,0):e>0?new W(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?W.empty():e>=32?new W(0,this.lo<<e-32):e>0?new W(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new W(N(this.hi),N(this.lo))}rbit64(){return new W(Q(this.hi),Q(this.lo))}minus64(e){const t=this.lo-e.lo,i=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new W(t,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return O(this.lo)+O(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new W(this.lo,this.hi|1<<e-32):new W(this.lo|1<<e,this.hi)}without(e){return e>=32?new W(this.lo,this.hi&~(1<<e-32)):new W(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new W(this.lo,this.hi^1<<e-32):new W(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new W(this.lo&this.lo-1,this.hi):new W(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||!!(this.lo&this.lo-1)||!!(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}const X=e=>e>>3,U=e=>7&e,V=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Z=(e,t)=>{let i=W.empty();for(const o of t){const t=e+o;0<=t&&t<64&&Math.abs(U(e)-U(t))<=2&&(i=i.with(t))}return i},Y=e=>{const t=[];for(let i=0;i<64;i++)t[i]=e(i);return t},H=Y(e=>Z(e,[-9,-8,-7,-1,1,7,8,9])),J=Y(e=>Z(e,[-17,-15,-10,-6,6,10,15,17])),ee={white:Y(e=>Z(e,[7,9])),black:Y(e=>Z(e,[-7,-9]))},te=Y(e=>W.fromFile(U(e)).without(e)),ie=Y(e=>W.fromRank(X(e)).without(e)),oe=Y(e=>{const t=new W(134480385,2151686160),i=8*(X(e)-U(e));return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),ne=Y(e=>{const t=new W(270549120,16909320),i=8*(X(e)+U(e)-7);return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),se=(e,t,i)=>{let o=i.intersect(t),n=o.bswap64();return o=o.minus64(e),n=n.minus64(e.bswap64()),o.xor(n.bswap64()).intersect(t)},re=(e,t)=>{const i=W.fromSquare(e);return se(i,oe[e],t).xor(se(i,ne[e],t))},ae=(e,t)=>((e,t)=>se(W.fromSquare(e),te[e],t))(e,t).xor(((e,t)=>{const i=ie[e];let o=t.intersect(i),n=o.rbit64();return o=o.minus64(W.fromSquare(e)),n=n.minus64(W.fromSquare(63-e)),o.xor(n.rbit64()).intersect(i)})(e,t)),le=(e,t,i)=>{switch(e.role){case"pawn":return((e,t)=>ee[e][t])(e.color,t);case"knight":return(e=>J[e])(t);case"bishop":return re(t,i);case"rook":return ae(t,i);case"queen":return((e,t)=>re(e,t).xor(ae(e,t)))(t,i);case"king":return(e=>H[e])(t)}};function he(e){return function(e){let t=[],i=function(e){let t=[],i=function(e){let t=W.empty();for(let i of Object.keys(e))t=t.set(e[i],!0);return t}(e);for(let o of Object.keys(e)){let n=we(o),s=e[o],r=le(n,s,i);for(let a of r)for(let l of Object.keys(e))if(e[l]===a){let a,h=e[l],c=i.without(h),u=le(n,s,c).diff(r);for(let t of u)for(let i of Object.keys(e))e[i]===t&&(a=i);void 0!==a?t.push([o,l,a]):t.push([o,l])}}return t.sort((e,t)=>e.join(" ").localeCompare(t.join(" "))),t}(e);for(let o of Object.keys(e)){let e=[],n=[],s=[],r=[],a=[];for(let t of i)t[0]===o?2===t.length?e.push(t[1]):r.push([t[1],t[2]]):t[1]===o?2===t.length?n.push(t[0]):s.push([t[0],t[2]]):t[2]===o&&a.push([t[0],t[1]]);t.push({p1:o,attacks:e,attacked_by:n,blocks:s,blocked_attacks:r,blocked_attacked_by:a})}return t}(pe(e))}const ce=e=>!e.attacked_by.find(e=>e.toLowerCase()===e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()===e[0])&&!e.blocks.find(e=>e[0].toLowerCase()===e[0]),ue=e=>!e.attacked_by.find(e=>e.toLowerCase()!==e)&&!e.blocked_attacked_by.find(e=>e[0].toLowerCase()!==e[0])&&!e.blocks.find(e=>e[0].toLowerCase()!==e[0]);function fe(e){let t=e.p1,i=e.attacks.map(e=>`+${e}`).join(" "),o=e.attacked_by.map(e=>`${e}+`).join(" "),n=e.blocks.map(e=>`${e[0]}+|${e[1]}`).join(" "),s=e.blocked_attacks.map(e=>`+${e[0]}/${e[1]}`).join(" "),r=e.blocked_attacked_by.map(e=>`${e[0]}+/${e[1]}`).join(" "),a=[t];return ce(e)&&a.push("z+"),ue(e)&&a.push("Z+"),""!==i&&a.push(i),""!==o&&a.push(o),""!==n&&a.push(n),""!==s&&a.push(s),""!==r&&a.push(r),a.join(" ")}function pe(e){e=e.split(" ")[0];let t={},i=7;for(let o of e.split("/")){let e=0;for(let n of o)if(qe(n)){let o=V(e,i);if(void 0!==o){let e=n,i=2;for(;void 0!==t[e];)e=n+i,i++;t[e]=o}e+=1}else e+=parseInt(n);i-=1}return t}const de={r:"rook",n:"knight",b:"bishop",p:"pawn",q:"queen",k:"king"};function qe(e){return void 0!==de[e.toLowerCase()]}function we(e){var t;return{color:(t=e).toLowerCase()===t?"black":"white",role:de[e.toLowerCase().replace(/[2345678]/,"")]}}let me;console.log(he("8/8/4r3/r1n5/1k1B4/6Np/1PP1n3/2KRR3 w - - 0 1").map(fe));const be=()=>{let{chapter:e}=pt[ft];me!==e&&(E(),setTimeout(()=>{0===e?function(){let e=c.currentTime;y.play(e),C.play(e)}():1===e?function(){let e=c.currentTime;P.play(e),G.play(e)}():2===e&&function(){let e=c.currentTime;w.play(e),b.play(e)}(),me=e},1e3))};let ke,_e,ge,ve,ye=await function(e){let t=new Image;return new Promise(i=>{t.onload=()=>i(t),t.src=e})}(e);function Ce(e,t,i,o=1,n=o){let s,r,a;t=Math.floor(t),i=Math.floor(i),e<4?(s=32,r=32*e,a=0):e<28?(s=16,r=(e-=4)%8*16,a=32+16*Math.floor(e/8)):(s=8,r=(e-=28)%16*8,a=80+8*Math.floor(e/16)),_e.drawImage(ye,r,a,s,s,t,i,s*o,s*n)}function Ee(e){ve.font="42px Arial",ve.shadowColor="black",ve.shadowBlur=4;let t=1308,i=803.25;Ae(e[0],t,i,600,60),ve.font="28px Arial",t=1308,i=1039.5,Ae(e[1],t,i,600,60)}function Ae(e,t,i,o,n){const s=e.split(" ");let r="",a=i;for(let l=0;l<s.length;l++){const e=r+s[l]+" ";ve.measureText(e).width>o&&l>0?(ve.fillText(r,t,a),r=s[l]+" ",a+=n):r=e}ve.fillText(r,t,a)}function Me(){if(ve.clearRect(0,0,1920,1080),_e.fillStyle="black",_e.fillRect(0,0,480,270),wt)return function(){if(-1===mt&&(ve.strokeStyle=vt%1e3<500?"white":"gray",ve.lineWidth=3,ve.font="80px Arial",ve.strokeText("click to begin",100,1e3)),mt>5500)Ce(0,200,50,2.5),Ce(98,300,100,5);else if(mt>4e3)Ce(1,280,90,3);else if(mt>1800)Ce(4,280,90,6);else if(mt>800)Ce(10,290,90,6);else if(-1===mt){let e=vt%4e3;Ce(e<500||e>800&&e<1300?100:99,300,100,5),Ce(101,180,150,6)}}(),void Ce(28,...ut);Ce(110,0,0,320);let e=10,t=24;for(let o=0;o<8;o++)for(let i=0;i<8;i++){Ce(108+((o+i)%2==1?1:0),e+3.5*o*8,t+3.5*i*8,3.5)}e=10,t=0,Ce(111,e,t,28,3),t=248,Ce(111,e,t,28,3);for(let o of ht)Ce(Ve(o.piece),...o.pos,3),o.piece.match(/2/)&&Ce(82,...o.pos,3),o.is_hovering&&Ce(112,...o.pos,3);Ce(111,318,188,20,10),Ee(gt||(kt||(_t||bt))),Ce(111,238,2,30,23);let i=at.find(e=>e.is_hovering);if(i){let[e,t,o,n]=i.bb;_e.strokeRect(e,t,o,n);for(let s of i.circles)Ce(112,...s,3);for(let s of i.no_arrows)Ie(s[0],s[1],"red");for(let s of i.yes_arrows)Ie(s[0],s[1],"green")}for(let o of rt)Ce(o[0],o[1],o[2]);if(lt&&Ce(Ve(lt.piece),...lt.pos,3),void 0!==kt){!function(e,t,i,o){for(let n=0;n<t;n++)Ce(e+n,i+8*n*2,o,2)}(119,5,400,246+(Ct&&vt%500<200?2:0))}if(function(){let e=Ke,t=Re;Ce(111,238,188,9.8,10);let i=pt[ft];ve.font="bold 64px Arial",ve.fillText(`${i.chapter}-${i.level}`,265*e,204*t);let o=vt%500<250?3:0,n=At?o:0;Ce(117,242-(Et?o:0),190,2),Ce(118,296+n,190,2),Ce(Pe+(pt[ft].is_revealed?16:pt[ft].is_solved?8:0),250,214,3),Ce(void 0===xt||xt?116:115,298,214,2)}(),Ce(28,...ut),Mt){let e=80*Math.sin(.008*vt),t=80*Math.sin(.008*vt),i=80*Math.sin(.003*vt);ve.font="bold 180px Arial",ve.shadowColor="purple",ve.shadowBlur=10,ve.lineWidth=4,ve.strokeStyle="purple",ve.strokeText("Mor",200+e,400+t),ve.strokeText("Chess",1e3-e,400+t),ve.fillStyle="white",ve.shadowBlur=0,ve.fillText("Mor",200+e,400+t),ve.fillText("Chess",1e3-e,400+t),ve.fillStyle="black",ve.fillText("Black",200,800-.1*i),ve.fillText("Cat",800,800-.1*i)}}let Be,xe,Pe,Ge,$e=[250,214,48,48],Fe=[298,214,16,16];const De={neutral:4,happy:5,sad:6,angry:7,surprised:8,sleepy:9,playful:10},Le=[242,190,16,16],Te=[296,190,16,16],Ke=4,Re=4;function Ie(e,t,i){ve.lineWidth=10,ve.strokeStyle=i,ve.lineCap="round",ve.beginPath(),ve.moveTo(e[0]*Ke,e[1]*Re),ve.lineTo(t[0]*Ke,t[1]*Re),ve.stroke()}const je=[400,246,80,16];function ze(e,t){return fe(e)===fe(t)}const Se=(e,t,i)=>rt.push([e,t,i,0]),Oe=(e,t,i,o,n,s,r,a)=>at.push({info:e,bb:[t,i,o,n],is_hovering:!1,circles:s,yes_arrows:r,no_arrows:a});function Ne(e,t,i){const o=e=>ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos),n=(e,t)=>{let i=ht.filter(t=>t.piece===e&&void 0!==Je(t.pos)).map(e=>e.pos)[0],o=ht.filter(e=>e.piece===t&&void 0!==Je(e.pos)).map(e=>e.pos)[0];if(i&&o){return[[[i[0]+12,i[1]+12],[o[0]+12,o[1]+12]]]}return[]};let s=[],r=[],a=[];const l=(e,t,i,o,n)=>{Oe(e,t,i,o,n,s,r,a),s=[],r=[],a=[]},h=Se;h(Ve(e.p1),t+4,i+4),e.p1.match(/2/)&&h(82,t+4,i+4),s=o(e.p1),l(Qe.yes_piece(e.p1),t+2,i+2,12,12),h(39,(t+=8)+4,i+4),t+=8;let c=tt();if(ce(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()===e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()===e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(33,t+4,i+4):h(32,t+4,i+4),s=o(e.p1),l(Qe.zero_attacked_by_lower(e.p1),t+2,i+2,12,12),t+=12}if(ue(e)){let r=c.find(t=>t.p1===e.p1),u=r?.attacked_by.filter(e=>e.toLowerCase()!==e)??[];u=u.concat(r?.blocks.map(e=>e[0]).filter(e=>e.toLowerCase()!==e)??[]),a=[...u.flatMap(t=>n(e.p1,t))],e.p1.toLowerCase()===e.p1?h(32,t+4,i+4):h(33,t+4,i+4),s=o(e.p1),l(Qe.zero_attacked_by_upper(e.p1),t+2,i+2,12,12),t+=12}for(let u of e.attacks){h(35,t+2,i+4);let o=c.find(t=>t.p1===e.p1);0===(o?.attacks.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],l(Qe.attacks(e.p1,u),t+4,i+2,14,12),t+=5,h(Ve(u),t+4,i+4),u.match(/2/)&&h(82,t+4,i+4),t+=9}for(let u of e.attacked_by){h(Ve(u),t+4,i+4),u.match(/2/)&&h(82,t+4,i+4);let f=c.find(t=>t.p1===e.p1);0===(f?.attacked_by.filter(e=>e===u)??[]).length?a=[...n(e.p1,u)]:r=[...n(e.p1,u)],s=o(e.p1),l(Qe.attacked_by(e.p1,u),t+4,i+2,14,12),h(34,(t+=9)+2,i+4),t+=5}for(let u of e.blocks){h(Ve(u[1]),t+4,i+4),u[1].match(/2/)&&h(82,t+4,i+4);let o=c.find(t=>t.p1===e.p1);0===(o?.blocks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(u[0],u[1])],l(Qe.blocks(e.p1,...u),t+4,i+2,24,12),h(36,(t+=9)+2,i+4),t+=5,h(Ve(u[0]),t+4,i+4),u[0].match(/2/)&&h(82,t+4,i+4),t+=9}for(let u of e.blocked_attacks){h(Ve(u[1]),t+4,i+4),u[0].match(/2/)&&h(82,t+4,i+4);let o=c.find(t=>t.p1===e.p1);0===(o?.blocked_attacks.filter(e=>e[0]===u[0]&&e[1]===u[1])??[]).length?a=[...n(u[0],u[1]),...n(e.p1,u[1])]:r=[...n(e.p1,u[1])],l(Qe.blocked_attacks(e.p1,u[1],u[0]),t+4,i+2,24,12),h(37,(t+=9)+2,i+4),t+=5,h(Ve(u[0]),t+4,i+4),u[0].match(/2/)&&h(82,t+4,i+4),t+=9}for(let u of e.blocked_attacked_by){h(Ve(u[1]),t+4,i+4),u[1].match(/2/)&&h(82,t+4,i+4);let o=c.find(t=>t.p1===e.p1),s=o?.blocked_attacked_by.filter(e=>e[0]===u[0]&&e[1]===u[1])??[];0===s.length?a=[...n(u[0],u[1]),...n(e.p1,u[0])]:r=[...n(e.p1,u[0])],s=o?.attacked_by.filter(e=>e===u[0]).map(e=>[e,e])??[],s=s.concat(o?.blocks.filter(e=>e[0]===u[0])??[]),s.length>0&&(a=[...n(e.p1,u[0])]),l(Qe.blocked_attacked_by(e.p1,u[0],u[1]),t+4,i+2,24,12),h(38,(t+=9)+2,i+4),t+=5,h(Ve(u[0]),t+4,i+4),u[0].match(/2/)&&h(82,t+4,i+4),t+=9}return[t,i]}const Qe={welcome0:["welcome to mor chess; drag pieces onto the board, but there are some rules above. hover over them for details.","drag a piece off the board to remove it."],welcome1:["each chapter; proressively reveals more pieces of a single position.","call out the cat 3 times, if you get in a mess ;)"],welcome2:["chess tactics; are born out of relationships.","our job is to entangle them."],welcome3:["rules are tools to an end.","look here, just enough to keep the cats happy."],well_done:["Congratulations, you satisfied all rules. Time to go deeper.","Click Next to continue."],well_end:["the end; chess is fascinating isn't it, go play some chess.","Thank's for playing"],equals:e=>["left side is the goal, right side is the board; your goal is to match them equal.",`this rule ${e?"has matched correctly.":"has not been matched yet."}`],no_piece:e=>[`${Ue(e)} hasn't been placed yet.`,""],yes_piece:e=>[`A ${Ue(e)} on the board.`,""],zero_attacked_by_lower(e){let t=e.toLowerCase()===e?"defenders":"attackers";return[`${Ue(e)} has zero ${t}.`,""]},zero_attacked_by_upper(e){let t=e.toLowerCase()===e?"attackers":"defenders";return[`${Ue(e)} has zero ${t}.`,""]},attacks(e,t){let i=Ue(e),o=Ue(t);return[`${i} is ${We(e,t)} ${o}.`,`${o} shouldn't be blocking an attack of ${i}.`]},attacked_by(e,t){let i=Ue(e),o=Ue(t);return[`${i} is ${Xe(e,t)} by ${o}.`,`${i} shouldn't be blocking an attack of ${o}.`]},blocks(e,t,i){let o=Ue(e),n=Ue(t),s=Ue(i);return[`${o} blocks ${n} ${We(t,i)} ${s}.`,""]},blocked_attacks(e,t,i){let o=Ue(e),n=Ue(t),s=Ue(i);return[`${o} is ${We(e,t)} ${n}, but that's blocked by ${s}.`,""]},blocked_attacked_by(e,t,i){let o=Ue(e),n=Ue(t),s=Ue(i);return[`${o} is ${Xe(e,t)} by ${n}, but that's blocked by ${s}.`,""]}},We=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defending":"attacking",Xe=(e,t)=>e.toLowerCase()===e==(t.toLowerCase()===t)?"defended":"attacked";function Ue(e){let t=we(e),i=e.match(/2/)?"2":"";return t.role[0].toUpperCase()+t.role.slice(1)+i}function Ve(e){let t=we(e);return 76+{pawn:0,rook:1,bishop:2,knight:3,queen:4,king:5}[t.role]+("white"===t.color?16:0)}function Ze(e){if(mt>0&&(mt-=e,mt<=0&&(wt=!1)),Ge-=e,Ge<0&&(Ge=0),Ge>1e3&&(Ge=0,pt[ft].is_revealed||(pt[ft].is_revealed=!0,function(){Pt();let e=pe(pt[ft].fen);for(let t of Object.keys(e)){let i=U(e[t]),o=X(e[t]);ht.push(nt(t,He([i,7-o])))}st=!0}())),xe-=e,vt+=e,xe<0&&(Pe=vt%1e4<2e3?De.sleepy:De.neutral),ct.is_hovering){ut=ct.is_hovering;for(let e of ht)e.is_hovering=!1;for(let e of ht)if(t(ot(e),it(ut))){e.is_hovering=!0;break}if(void 0!==lt)lt.pos=[ut[0]-4,ut[1]-4];else{for(let e of at)e.is_hovering=!1;for(let e of at)t(e.bb,it(ut))&&(e.is_hovering=!0)}yt=t($e,it(ut)),Ct=void 0!==kt&&t(je,it(ut)),Et=t(Le,it(ut)),At=t(Te,it(ut)),yt&&xe<0&&(Pe=De.playful,xe=260)}if(ct.is_just_down){let e=ht.find(e=>e.is_hovering);if(e){e.is_dragging=!0,lt=nt(e.piece,e.pos),Je(e.pos)&&(lt.orig=e)}}if(ct.is_up){if(wt&&(mt=6e3,T(S.done_chapter)),void 0!==xt||Bt||(xt=!1,be()),lt){if(lt.orig){let e=lt.orig.pos;ht=ht.filter(t=>!(t.pos[0]===e[0]&&t.pos[1]===e[1]))}let e=Je(ct.is_up);if(e){let t=He(e);ht=ht.filter(e=>!(e.pos[0]===t[0]&&e.pos[1]===t[1])),ht.push(nt(lt.piece,t))}!function(){for(let e of ht){let t=Je(e.pos);if(!t)continue;let i=ht.find(i=>{if(i!==e&&i.piece[0]===e.piece[0]){let e=Je(i.pos);if(e){let i=V(...t);if(V(...e)<i)return!0}}})?"2":"";e.piece=e.piece[0]+i}}(),lt=void 0,st=!0,Pe=De.surprised,xe=3e3,T(S.drop)}Ct&&(ft===pt.length-1?Ye(0):Ye(1)),Et&&Ye(-1),At&&Ye(1),t(Fe,it(ct.is_up))&&(xt=!xt,xt?E():be()),yt&&(Pe=De.sad,xe=1e3,Ge+=540)}if(st){st=!1,rt=[],at=[];let e=qt(),t=tt(),i=0,o=!0,n=2;for(let s of e){let e=238;[e,n]=Ne(s,e,n);let r=t.find(e=>e.p1===s.p1),a=void 0!==r&&ze(s,r)?30:29;30===a&&i++,o=o&&30===a,Se(a,e+4,n+4),Oe(Qe.equals(30===a),e+2,n+2,12,12,[],[],[]),e+=10,void 0===r?(Se(31,e+4,n+4),Oe(Qe.no_piece(s.p1),e+2,n+2,12,12,[],[],[])):[e,n]=Ne(r,e,n),n+=14,e=182}Be>i&&(Pe=De[Math.random()<.8?"angry":"sad"],xe=1500),Be=i,o?function(){pt[ft].is_solved=!0,pt.filter(e=>e.chapter===pt[ft].chapter).every(e=>e.is_solved)?T(S.done_chapter):T(S.correct);Pe=De.playful,xe=5e3,ft<pt.length-1?-1===pt.findIndex(e=>!e.is_solved)?Mt=!0:kt=Qe.well_done:-1===pt.findIndex(e=>!e.is_solved)?Mt=!0:kt=Qe.well_end}():kt=void 0}if(_t=at.find(e=>e.is_hovering)?.info,ct.update(e),Mt){for(let t of ht)t.pos[1]-=.1*e*Math.random(),t.pos[1]<-20&&(t.pos[1]=400);vt%500<17&&(ft+=1,ft>pt.length-1&&(ft=0),st=!0)}}function Ye(e){be(),pt[ft].is_revealed&&(pt[ft].is_revealed=!1,pt[ft].is_solved=!1);let t=ft+e;if(0===e&&(t=pt.findIndex(e=>!e.is_solved)),t<0||t>=pt.length)return;let i=pt[t].chapter!==pt[ft].chapter;i?(T(S.chapter),Pt()):T(S.next),st=!0,ft=t,i&&(bt=Qe[`welcome${pt[ft].chapter}`],Pe=De.surprised,xe=5e3)}function He(e){return[10+3.5*e[0]*8+2,24+3.5*e[1]*8+4]}function Je(e){let[t,i]=e;if(t-=10,i-=24,!(t<0||t>=224||i<0||i>=224))return t=Math.floor(t/28),i=Math.floor(i/28),[t,i]}function et(e){return he(e)}function tt(){return et(function(){let e={};for(let i of ht){let t=Je(i.pos);if(t){let o=i.piece;e[V(...t)]=o}}let t="";for(let i=0;i<8;i++){let o=0;for(let n=0;n<8;n++){let s=V(n,i);e[s]?(o>0&&(t+=o),t+=e[s][0],o=0):o++}o>0&&(t+=o),t+="/"}return t}())}function it(e){return[e[0]+1,e[1]+1,6,6]}function ot(e){let[t,i]=e.pos;return[t,i,24,24]}function nt(e,t){return{piece:e,pos:t,is_hovering:!1,is_dragging:!1}}let st,rt,at,lt,ht,ct,ut,ft,pt=[dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",0,0),dt("6k1/8/8/8/8/8/5P2/6K1 w - - 0 1",0,1),dt("6k1/8/8/8/8/8/6PP/6K1 w - - 0 1",0,2),dt("6k1/8/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,3),dt("6k1/b7/8/3r4/8/5B2/5P2/6K1 w - - 0 1",0,4),dt("1r4k1/bP6/8/8/8/5B2/5P2/6K1 w - - 0 1",0,5),dt("1r4k1/bP6/4p3/3r4/8/5B2/5P2/6K1 w - - 0 1",0,6),dt("1r4k1/bP6/4p3/p2r4/8/5B2/5P2/R5K1 w - - 0 1",0,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",1,0),dt("8/1K6/4b3/8/3r4/4k3/8/8 w - - 0 1",1,1),dt("8/1K6/4b3/4R3/3rP3/4k3/8/8 w - - 0 1",1,2),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",2,0),dt("8/5k2/8/8/8/8/6PP/6K1 w - - 0 1",2,1),dt("8/5k2/4rn2/8/8/8/6PP/6K1 w - - 0 1",2,2),dt("8/5k2/8/8/8/8/8/R2R2K1 w - - 0 1",2,3),dt("3r4/5k2/8/8/3n4/8/8/3R2K1 w - - 0 1",2,4),dt("3r4/6k1/5rn1/8/3n4/8/6PP/3R2K1 w - - 0 1",2,5),dt("3r4/6k1/5rn1/1p6/2Nn4/8/6PP/R2R2K1 w - - 0 1",2,6),dt("3r4/5k2/4rn2/1p6/2N5/3n4/1B4PP/R2R2K1",2,7),dt("5k2/8/8/8/8/8/8/4K3 w - - 0 1",3,0),dt("6k1/8/8/8/8/8/7q/1K1Q4 w - - 0 1",3,1),dt("6k1/7p/8/8/8/8/2Pr3q/1K1QR3 w - - 0 1",3,2),dt("6k1/7p/8/6p1/8/8/1PPr3q/1K1QR3 w - - 0 1",3,3)];function dt(e,t,i){return{chapter:t,level:i,fen:e,is_solved:!1,is_revealed:!1}}const qt=()=>et(pt[ft].fen);let wt,mt,bt,kt,_t,gt,vt,yt,Ct,Et,At,Mt,Bt,xt;function Pt(){ht=[nt("p",[20,0]),nt("n",[52,0]),nt("b",[84,0]),nt("r",[116,0]),nt("q",[148,0]),nt("k",[180,0]),nt("P",[20,248]),nt("N",[52,248]),nt("B",[84,248]),nt("R",[116,248]),nt("Q",[148,248]),nt("K",[180,248])]}!function(e){ke=document.createElement("canvas"),ke.width=480,ke.height=270,ke.classList.add("pixelated"),_e=ke.getContext("2d"),_e.imageSmoothingEnabled=!1,_e.fillStyle="black",ge=document.createElement("canvas"),ge.width=1920,ge.height=1080,ve=ge.getContext("2d");let t=document.createElement("div");t.classList.add("content"),t.appendChild(ke),t.appendChild(ge),e.appendChild(t),wt=!0,mt=-1,Ge=0,Bt&&E(),Bt=!1,Be=0,Pe=De.happy,xe=5e3,Mt=!1,Et=!1,At=!1,Ct=!1,vt=0,gt=void 0,kt=void 0,_t=void 0,bt=Qe.welcome0,st=!0,rt=[],at=[],ft=0,lt=void 0,ht=[],Pt(),ct=i(ke),ut=[0,0],function(e,t){const i=1e3/60;let o=performance.now(),n=0;requestAnimationFrame(function s(r){requestAnimationFrame(s);let a=Math.min(r-o,250);for(o=r,n+=a;n>=i;)e(i),n-=i;t(n/i)})}(Ze,Me)}(document.getElementById("app"));
